<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>股票策略卡</title>
  <style>
    :root{
      --bg: #f4f6fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --shadow: 0 10px 25px rgba(17,24,39,.08);
      --radius: 18px;

      --green: #20c997;
      --green-2: #18b07f;
      --blue: #3b82f6;
      --red: #ef4444;

      --pill-red-bg: rgba(239,68,68,.10);
      --pill-amber-bg: rgba(245,158,11,.12);
      --pill-green-bg: rgba(16,185,129,.12);
      --pill-blue-bg: rgba(59,130,246,.12);

      --pill-red-text: #b91c1c;
      --pill-amber-text: #92400e;
      --pill-green-text: #065f46;
      --pill-blue-text: #1d4ed8;

      --divider: rgba(17,24,39,.06);
    }

    /* Responsive UI scale (mobile): shrink overall UI to 80% without breaking fixed overlays (uses CSS zoom) */
    :root{ --ui-scale: 0.8; }
    @media (max-width: 560px){
      @supports (zoom: 1){
        body{ zoom: var(--ui-scale); }
        /* Compensate zoom shrink so layout still spans the viewport width */
        .app{
          width: calc(100% / var(--ui-scale));
          max-width: none;
          margin: 0;
        }
      }
    }


    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app{
      max-width: 520px;
      margin: 0 auto;
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
    }

    /* Header row: title on left, actions on right (two rows) */
    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      padding: 8px 4px 14px 4px;
    }
    .title-wrap{ flex: 1; min-width: 0; }
    .title{
      font-size: 26px;
      font-weight: 800;
      letter-spacing: .2px;
      margin: 6px 0 2px 0;
    }
    .subtitle{
      font-size: 14px;
      color: var(--muted);
      margin: 0;
      line-height: 1.5;
    }

    .header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 8px 4px 10px 4px;
      flex-wrap: nowrap;
    }
    .header-row .title-wrap{
      padding: 0;
      flex: 1 1 auto;
      min-width: 0;
    }
    .actions.actions-side{
      flex: 0 0 auto;
      display:flex;
      flex-direction:row;
      gap: 10px;
      padding: 2px 0 0 0;
      margin-left: auto;
      width: auto;
      max-width: none;
    }
    .actions.actions-side .btn{
      width: auto;
      justify-content:center;
      padding: 12px 14px;
      border-radius: 18px;
      white-space: nowrap;
    }

    /* keep comfortable layout on very small screens */
    @media (max-width: 360px){
      .actions.actions-side .btn{
        padding: 11px 10px;
      }
    }


    .actions{
      display:flex;
      flex-direction:column;
      gap: 10px;
      flex: 0 0 auto;
      width: 168px;
      padding-top: 6px;
    }
    .btn{
      border: 0;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 800;
      font-size: 15px;
      display:flex;
      align-items:center;
      gap: 10px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(17,24,39,.08);
      color: #fff;
      justify-content:center;
      width: 100%;
      white-space: nowrap;
    }
    .btn.green{ background: linear-gradient(180deg, var(--green), var(--green-2)); }
    .btn.blue{ background: linear-gradient(180deg, #4f8cff, var(--blue)); }
    .btn:active{ transform: translateY(1px); }

    .list{ padding: 0 4px 24px 4px; }

    .card{
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.6);
      margin-bottom: 10px;
    }
    .card-inner{ padding: 10px; }

    .card-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .codes{ min-width: 0; }
    .codes .big{
      font-size: 20px;
      font-weight: 900;
      letter-spacing: .2px;
      margin:0;
      line-height: 1.15;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 310px;
    }
    .codes .small{
      margin: 4px 0 0 0;
      font-size: 12px;
      color: var(--muted);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 310px;
    }

    .card-tools{
      display:flex;
      gap:8px;
      flex: 0 0 auto;
    }
    .tool{
      width: 30px;
      height: 30px;
      border-radius: 12px;
      border: 1px solid rgba(17,24,39,.08);
      background: rgba(255,255,255,.8);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .tool:active{ transform: translateY(1px); }
    .tool.danger{
      border-color: rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
    }

    .price-row{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      margin-top: 8px;
      gap: 12px;
    }
    .price-left .label{
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px 0;
    }
    .price-left .price{
      display:flex;
      align-items:center;
      gap: 8px;
      margin:0;
      font-size: 26px;
      font-weight: 950;
      color: var(--red);
      letter-spacing: .2px;
      line-height: 1;
    }
    .refresh-mini{
      width: 32px;
      height: 32px;
      border-radius: 12px;
      border: 1px solid rgba(17,24,39,.08);
      background: rgba(255,255,255,.85);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .refresh-mini:active{ transform: translateY(1px); }

    .price-right{
      text-align:right;
      min-width: 96px;
    }
    .status{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      font-weight: 850;
      font-size: 12px;
      color: #9a3412;
      background: rgba(245,158,11,.16);
      padding: 7px 9px;
      border-radius: 12px;
      margin-bottom: 6px;
      white-space:nowrap;
    }
    .time{
      font-size: 12px;
      color: var(--muted);
    }

    .divider{
      height: 1px;
      background: var(--divider);
      margin: 10px -10px 10px -10px;
    }

    /* Pills on one row: 4 cols by default; 5 cols when TP2 exists */
    .pills{
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(4, 1fr);
    }
    .pills.cols-3{ grid-template-columns: repeat(3, 1fr); }
    .pills.cols-5{ grid-template-columns: repeat(5, 1fr); }

    .pill{
      display:flex;
      flex-direction:column;
      gap: 3px;
      padding: 8px 10px;
      border-radius: 14px;
      min-width: 0;
    }
    .pill .k{
      font-size: 12px;
      font-weight: 850;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .pill .v{
      font-size: 14px;
      font-weight: 950;
      letter-spacing: .2px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .pill.red{ background: var(--pill-red-bg); color: var(--pill-red-text); }
    .pill.amber{ background: var(--pill-amber-bg); color: var(--pill-amber-text); }
    .pill.green{ background: var(--pill-green-bg); color: var(--pill-green-text); }
    .pill.blue{ background: var(--pill-blue-bg); color: var(--pill-blue-text); }

    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,.45);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .overlay.show{ display:flex; }

    .modal{
      width: min(520px, 100%);
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 20px 60px rgba(17,24,39,.25);
      overflow:hidden;
    }
    .modal-hd{
      padding: 14px 16px;
      border-bottom: 1px solid var(--divider);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modal-hd h3{
      margin:0;
      font-size: 16px;
      font-weight: 900;
    }
    .modal-bd{
      padding: 14px 16px 6px 16px;
    }

    /* Make form single-column for phones */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-bottom: 10px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 750;
    }
    input{
      border: 1px solid rgba(17,24,39,.12);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
    }
    input:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.10);
    }
    .modal-ft{
      padding: 12px 16px 16px 16px;
      display:flex;
      gap: 10px;
    }
    .btn2{
      flex:1;
      border-radius: 16px;
      border:0;
      padding: 12px 14px;
      font-weight: 900;
      cursor:pointer;
    }
    .btn2.ghost{
      background: rgba(17,24,39,.06);
      color: var(--text);
    }
    .btn2.primary{
      background: linear-gradient(180deg, #4f8cff, var(--blue));
      color: #fff;
    }

    @media (max-width: 420px){
      .actions{ width: 150px; }
      .btn{ font-size: 14px; padding: 11px 12px; }
      .codes .big{ max-width: 240px; }
      .codes .small{ max-width: 240px; }
    }
    @media (max-width: 360px){
      .actions{ width: 138px; }
      .codes .big{ max-width: 210px; }
      .codes .small{ max-width: 210px; }
    }

    svg{ width:18px; height:18px; }
  </style>
</head>
<body>
  <div class="app">
    


    <div class="header">
      <div class="header-row">
    <div class="title-wrap">
      <div class="title">股票策略卡</div>
      <p class="subtitle">多股票决策辅助工具</p>
    </div>

    <div class="actions actions-side">
      <button class="btn green" id="btnUpdateAll">
        <span style="display:inline-flex;align-items:center;gap:10px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 0 1-15.3 6.4"></path>
            <path d="M3 12a9 9 0 0 1 15.3-6.4"></path>
            <path d="M3 3v6h6"></path>
            <path d="M21 21v-6h-6"></path>
          </svg>
          全部更新
        </span>
      </button>
      <button class="btn blue" id="btnAdd">+ 添加</button>
    </div>
  </div>
    </div>

    <div class="list" id="list"></div>
  </div>

  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-hd">
        <h3 id="modalTitle">添加股票</h3>
        <button class="tool" id="btnClose" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6L6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="modal-bd">
        <div class="field">
          <label>股票代码（6 位，如 000001 / 600000 / 430047）</label>
          <input id="fSymbol" inputmode="numeric" placeholder="000001" maxlength="12" />
        </div>

        <div class="grid">
          <div class="field">
            <label>止损</label>
            <input id="fStop" inputmode="decimal" placeholder="12.00" />
          </div>
          <div class="field">
            <label>支撑</label>
            <input id="fSupport" inputmode="decimal" placeholder="14.00" />
          </div>
          <div class="field">
            <label>突破位</label>
            <input id="fBreakout" inputmode="decimal" placeholder="16.00" />
          </div>
          <div class="field">
            <label>止盈1</label>
            <input id="fTp1" inputmode="decimal" placeholder="19.00" />
          </div>
          <div class="field">
            <label>止盈2（可选）</label>
            <input id="fTp2" inputmode="decimal" placeholder="22.00" />
          </div>
        </div>
      </div>

      <div class="modal-ft">
        <button class="btn2 ghost" id="btnCancel">取消</button>
        <button class="btn2 primary" id="btnSave">保存</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Data Layer ----------
    const LS_KEY = "strategy_cards_frontend_only_v3";
    const LS_DRAFT_KEY = "strategy_cards_form_draft_v2";

    /** @type {{id:string, symbol:string, price:number, status:string, updatedAt:string, stop:number, support:number, breakout:number, tp1:number, tp2:(number|null), name?:string, marketCode?:string}[]} */
    let items = load() ?? [];

    items = migrateItems(items);

    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed)) return null;
        return parsed;
      }catch(_){
        return null;
      }
    }


    function migrateItems(arr){
      if(!Array.isArray(arr)) return [];
      return arr.map((x) => {
        const it = (x && typeof x === "object") ? x : {};
        // Add new field: breakout. If missing, default to support (best-effort).
        const support = Number(it.support);
        const breakout = Number.isFinite(Number(it.breakout)) ? Number(it.breakout) :
                         (Number.isFinite(support) ? support : 0);
        const tp2 = (it.tp2 === null || it.tp2 === undefined || it.tp2 === "") ? null : Number(it.tp2);
        return {
          ...it,
          stop: Number(it.stop),
          support: support,
          breakout: breakout,
          tp1: Number(it.tp1),
          tp2: (Number.isFinite(tp2) ? tp2 : null),
        };
      });
    }

    function persist(){
      localStorage.setItem(LS_KEY, JSON.stringify(items));
    }

    function loadDraft(){
      try{
        const raw = localStorage.getItem(LS_DRAFT_KEY);
        if(!raw) return {};
        const d = JSON.parse(raw);
        return (d && typeof d === "object") ? d : {};
      }catch(_){
        return {};
      }
    }
    function saveDraft(d){
      try{ localStorage.setItem(LS_DRAFT_KEY, JSON.stringify(d)); }catch(_){}
    }

    function nowTime(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${hh}:${mm}:${ss}`;
    }

    function formatCNY(n){
      const x = Number(n);
      if(Number.isNaN(x)) return "¥0.00";
      return "¥" + x.toFixed(2);
    }

    // ---------- Quote API (Pure Frontend via script injection) ----------
    function toTencentMarketCode(symbol){
      const s = String(symbol).trim();
      if(!/^\d{6}$/.test(s)) throw new Error("symbol must be 6 digits");
      // 6xxxxx -> sh, 0/3xxxxx -> sz, 8/4xxxxx -> bj
      if (s.startsWith("6")) return "sh" + s;
      if (s.startsWith("0") || s.startsWith("3")) return "sz" + s;
      if (s.startsWith("8") || s.startsWith("4")) return "bj" + s;
      return "sz" + s;
    }

    function injectScript(url){
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = url;
        s.charset = "gbk";
        s.async = true;
        s.onload = () => { s.remove(); resolve(); };
        s.onerror = () => { s.remove(); reject(new Error("script load failed")); };
        document.head.appendChild(s);
      });
    }

    function parseTencentVar(marketCode){
      const key = "v_" + marketCode;
      const raw = window[key];
      if(!raw || typeof raw !== "string") throw new Error(`missing ${key}`);

      const s = raw.replace(/^"+|"+$/g, "");
      const parts = s.split("~");

      const name = parts[1] || "";
      const code6 = parts[2] || marketCode.slice(2);

      // price usually at index 3
      let price = Number(parts[3]);
      if(!Number.isFinite(price)){
        for(let i=3;i<Math.min(parts.length, 20);i++){
          const x = Number(parts[i]);
          if(Number.isFinite(x) && x > 0) { price = x; break; }
        }
      }
      if(!Number.isFinite(price)) throw new Error(`bad price for ${marketCode}`);

      // datetime: find 14-digit token (YYYYMMDDhhmmss)
      let timeStr = "";
      for(const t of parts){
        if(/^\d{14}$/.test(t)){
          const hh = t.slice(8,10);
          const mm = t.slice(10,12);
          const ss = t.slice(12,14);
          timeStr = `${hh}:${mm}:${ss}`;
          break;
        }
      }
      if(!timeStr) timeStr = nowTime();

      return { marketCode, code6, name, price, time: timeStr };
    }

    async function fetchTencentBatch(marketCodes){
      const uniq = Array.from(new Set(marketCodes.filter(Boolean)));
      if(uniq.length === 0) return [];

      const url = `https://qt.gtimg.cn/q=${encodeURIComponent(uniq.join(","))}&_=${Date.now()}`;
      await injectScript(url);

      const out = [];
      for(const mc of uniq){
        try{
          out.push(parseTencentVar(mc));
        }catch(e){
          out.push({ marketCode: mc, error: String(e.message || e) });
        }
      }
      return out;
    }

    // ---------- UI Rendering ----------
    const listEl = document.getElementById("list");

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function render(){
      listEl.innerHTML = "";
      if(items.length === 0){
        const empty = document.createElement("div");
        empty.style.padding = "14px 4px";
        empty.style.color = "var(--muted)";
        empty.style.fontWeight = "800";
        empty.textContent = "暂无股票。点击“添加”创建第一张策略卡。";
        listEl.appendChild(empty);
        return;
      }

      items.forEach((it) => {
        const hasTp2 = Number.isFinite(it.tp2);
        const colsClass = hasTp2 ? "cols-5" : "cols-4";

        const card = document.createElement("div");
        card.className = "card";

        const bigTitle = it.name ? escapeHtml(it.name) : escapeHtml(it.symbol);
        const sub = it.name ? `${escapeHtml(it.symbol)} · ${escapeHtml(it.name)}` : `${escapeHtml(it.symbol)}`;

        card.innerHTML = `
          <div class="card-inner">
            <div class="card-top">
              <div class="codes">
                <p class="big">${bigTitle}</p>
                <p class="small">${sub}</p>
              </div>
              <div class="card-tools">
                <button class="tool" data-act="edit" data-id="${it.id}" aria-label="Edit" title="编辑">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
                  </svg>
                </button>
                <button class="tool danger" data-act="del" data-id="${it.id}" aria-label="Delete" title="删除">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18"></path>
                    <path d="M8 6V4h8v2"></path>
                    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                    <path d="M10 11v6"></path>
                    <path d="M14 11v6"></path>
                  </svg>
                </button>
              </div>
            </div>

            <div class="price-row">
              <div class="price-left">
                <div class="label">当前价格</div>
                <div class="price">
                  ${formatCNY(it.price)}
                  <button class="refresh-mini" data-act="refresh" data-id="${it.id}" aria-label="Refresh" title="更新">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 12a9 9 0 0 1-15.3 6.4"></path>
                      <path d="M3 12a9 9 0 0 1 15.3-6.4"></path>
                      <path d="M3 3v6h6"></path>
                      <path d="M21 21v-6h-6"></path>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="price-right">
                <div class="status">${escapeHtml(it.status)}</div>
                <div class="time">${escapeHtml(it.updatedAt)}</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="pills ${colsClass}">
              <div class="pill red">
                <div class="k">止损</div>
                <div class="v">${formatCNY(it.stop)}</div>
              </div>
              <div class="pill amber">
                <div class="k">支撑</div>
                <div class="v">${formatCNY(it.support)}</div>
              </div>
              <div class="pill blue">
                <div class="k">突破位</div>
                <div class="v">${formatCNY(it.breakout)}</div>
              </div>
              <div class="pill green">
                <div class="k">止盈1</div>
                <div class="v">${formatCNY(it.tp1)}</div>
              </div>
              ${Number.isFinite(it.tp2) ? `
              <div class="pill green">
                <div class="k">止盈2</div>
                <div class="v">${formatCNY(it.tp2)}</div>
              </div>` : ``}
            </div>
          </div>
        `;

        listEl.appendChild(card);
      });
    }

    // ---------- Actions ----------
    listEl.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if(!act || !id) return;

      if(act === "del"){
        items = items.filter(x => x.id !== id);
        persist();
        render();
        return;
      }

      if(act === "edit"){
        openModal("edit", id);
        return;
      }

      if(act === "refresh"){
        await updateOnePrice(id);
        persist();
        render();
        return;
      }
    });

    document.getElementById("btnUpdateAll").addEventListener("click", async () => {
      await updateAllPrices();
    });

    document.getElementById("btnAdd").addEventListener("click", () => openModal("add"));
    // ---------- Modal logic ----------
    const overlay = document.getElementById("overlay");
    const modalTitle = document.getElementById("modalTitle");
    const fSymbol = document.getElementById("fSymbol");
    const fStop = document.getElementById("fStop");
    const fSupport = document.getElementById("fSupport");
    const fBreakout = document.getElementById("fBreakout");
    const fTp1 = document.getElementById("fTp1");
    const fTp2 = document.getElementById("fTp2");
    const btnClose = document.getElementById("btnClose");
    const btnCancel = document.getElementById("btnCancel");
    const btnSave = document.getElementById("btnSave");

    function wireDraft(){
      const handler = () => {
        saveDraft({
          stop: fStop.value.trim(),
          support: fSupport.value.trim(),
          breakout: fBreakout.value.trim(),
          tp1: fTp1.value.trim(),
          tp2: fTp2.value.trim(),
        });
      };
      [fStop, fSupport, fBreakout, fTp1, fTp2].forEach(el => el.addEventListener("input", handler));
    }
    wireDraft();

    let modalMode = "add"; // "add" | "edit"
    let editingId = null;

    function openModal(mode, id=null){
      modalMode = mode;
      editingId = id;

      if(mode === "add"){
        modalTitle.textContent = "添加股票";
        const d = loadDraft();
        fSymbol.value = "";
        fStop.value = d.stop ?? "";
        fSupport.value = d.support ?? "";
        fBreakout.value = d.breakout ?? "";
        fTp1.value = d.tp1 ?? "";
        fTp2.value = d.tp2 ?? "";
      }else{
        const it = items.find(x => x.id === id);
        if(!it) return;
        modalTitle.textContent = "编辑股票";
        fSymbol.value = it.symbol;
        fStop.value = String(it.stop ?? "");
        fSupport.value = String(it.support ?? "");
        fBreakout.value = String(it.breakout ?? "");
        fTp1.value = String(it.tp1 ?? "");
        fTp2.value = (Number.isFinite(it.tp2) ? String(it.tp2) : "");
      }

      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
      setTimeout(() => fSymbol.focus(), 50);
    }

    function closeModal(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
      editingId = null;
    }

    btnClose.addEventListener("click", closeModal);
    btnCancel.addEventListener("click", closeModal);
    overlay.addEventListener("click", (e) => {
      if(e.target === overlay) closeModal();
    });

    function parseNum(v){
      const n = Number(String(v).replaceAll(",","").trim());
      return Number.isFinite(n) ? n : NaN;
    }
    function parseOptionalNum(v){
      const s = String(v ?? "").trim();
      if(!s) return null;
      const n = Number(s.replaceAll(",",""));
      return Number.isFinite(n) ? n : NaN;
    }

    btnSave.addEventListener("click", async () => {
      const symbol = fSymbol.value.trim();
      const stop = parseNum(fStop.value);
      const support = parseNum(fSupport.value);
      const breakout = parseNum(fBreakout.value);
      const tp1 = parseNum(fTp1.value);
      const tp2 = parseOptionalNum(fTp2.value);

      if(!/^\d{6}$/.test(symbol)){
        toast("请输入 6 位股票代码");
        fSymbol.focus();
        return;
      }
      if(!Number.isFinite(stop) || !Number.isFinite(support) || !Number.isFinite(breakout) || !Number.isFinite(tp1)){
        toast("止损/支撑/突破位/止盈1 请输入有效数字");
        return;
      }
      if(tp2 !== null && !Number.isFinite(tp2)){
        toast("止盈2 请输入有效数字或留空");
        return;
      }
      if(tp2 !== null && tp2 <= tp1){
        toast("止盈2 需要大于 止盈1（或留空）");
        return;
      }

      if(modalMode === "add"){
        const it = {
          id: crypto.randomUUID(),
          symbol,
          price: 0.00,
          status: "监控中",
          updatedAt: "--:--:--",
          stop, support, breakout, tp1, tp2
        };
        items.unshift(it);
      }else{
        const it = items.find(x => x.id === editingId);
        if(!it) return;
        it.symbol = symbol;
        it.stop = stop;
        it.support = support;
        it.breakout = breakout;
        it.tp1 = tp1;
        it.tp2 = tp2;
      }

      persist();
      render();
      closeModal();

      await updateAllPrices();
    });

    // ---------- Price update (real) ----------
    async function updateAllPrices(){
      if(items.length === 0) return;

      const marketCodes = [];
      for(const it of items){
        try{
          const mc = toTencentMarketCode(it.symbol);
          it.marketCode = mc;
          marketCodes.push(mc);
        }catch(_){}
      }

      if(marketCodes.length === 0){
        toast("没有可更新的股票代码");
        return;
      }

      try{
        const quotes = await fetchTencentBatch(marketCodes);
        const map = new Map();
        for(const q of quotes){
          map.set(q.marketCode, q);
        }

        for(const it of items){
          const mc = it.marketCode || null;
          if(!mc) continue;
          const q = map.get(mc);
          if(!q) continue;

          if(q.error){
            it.updatedAt = nowTime();
            it.status = "更新失败";
            continue;
          }

          it.price = q.price;
          it.updatedAt = q.time || nowTime();
          it.name = q.name || it.name;

          // status rule: <= stop => 已止损; >= tp2 => 已止盈2; >= tp1 => 已止盈1; >= breakout => 已突破; else 监控中
          if (Number(it.price) <= Number(it.stop)) it.status = "已止损";
          else if (Number.isFinite(it.tp2) && Number(it.price) >= Number(it.tp2)) it.status = "已止盈2";
          else if (Number(it.price) >= Number(it.tp1)) it.status = "已止盈1";
          else if (Number(it.price) >= Number(it.breakout)) it.status = "已突破";
          else it.status = "监控中";
        }

        persist();
        render();
      }catch(e){
        toast(`批量更新失败: ${String(e.message || e)}`);
      }
    }

    async function updateOnePrice(id){
      const it = items.find(x => x.id === id);
      if(!it) return;

      let mc = "";
      try{
        mc = toTencentMarketCode(it.symbol);
        it.marketCode = mc;
      }catch(_){
        toast("股票代码不合法");
        return;
      }

      try{
        const quotes = await fetchTencentBatch([mc]);
        const q = quotes[0];
        if(!q || q.error) throw new Error(q?.error || "empty quote");

        it.price = q.price;
        it.updatedAt = q.time || nowTime();
        it.name = q.name || it.name;

        if (Number(it.price) <= Number(it.stop)) it.status = "已止损";
        else if (Number.isFinite(it.tp2) && Number(it.price) >= Number(it.tp2)) it.status = "已止盈2";
        else if (Number(it.price) >= Number(it.tp1)) it.status = "已止盈1";
        else if (Number(it.price) >= Number(it.breakout)) it.status = "已突破";
        else it.status = "监控中";
      }catch(e){
        it.status = "更新失败";
        it.updatedAt = nowTime();
        toast(`更新失败: ${String(e.message || e)}`);
      }
    }

    // ---------- 15s auto refresh ----------
    let timer = null;
    function startAutoRefresh(){
      if(timer) clearInterval(timer);
      timer = setInterval(() => {
        if (document.visibilityState === "visible") updateAllPrices();
      }, 15000);
    }
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") updateAllPrices();
    });

    // ---------- Tiny toast ----------
    let toastTimer = null;
    function toast(msg){
      clearTimeout(toastTimer);
      let el = document.getElementById("toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.style.position = "fixed";
        el.style.left = "50%";
        el.style.bottom = "18px";
        el.style.transform = "translateX(-50%)";
        el.style.background = "rgba(17,24,39,.92)";
        el.style.color = "white";
        el.style.padding = "10px 12px";
        el.style.borderRadius = "14px";
        el.style.fontWeight = "900";
        el.style.fontSize = "13px";
        el.style.boxShadow = "0 16px 40px rgba(17,24,39,.25)";
        el.style.zIndex = "100";
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.opacity = "1";
      toastTimer = setTimeout(() => { el.style.opacity = "0"; }, 1400);
    }

    // Initial
    render();
    persist();
    startAutoRefresh();
    updateAllPrices();
  </script>
</body>
</html>
