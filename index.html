<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%2064%2064%22%3E%20%3Cdefs%3E%20%3ClinearGradient%20id=%22g%22%20x1=%220%22%20x2=%221%22%20y1=%221%22%20y2=%220%22%3E%20%3Cstop%20offset=%220%22%20stop-color=%22#2563eb%22/%3E%20%3Cstop%20offset=%221%22%20stop-color=%22#22c55e%22/%3E%20%3C/linearGradient%3E%20%3C/defs%3E%20%3Crect%20x=%226%22%20y=%228%22%20width=%2252%22%20height=%2248%22%20rx=%2214%22%20fill=%22url(#g)%22/%3E%20%3Cpath%20d=%22M18%2041l10-12%208%209%2012-18%22%20fill=%22none%22%20stroke=%22#fff%22%20stroke-width=%225%22%20stroke-linecap=%22round%22%20stroke-linejoin=%22round%22/%3E%20%3Cpath%20d=%22M18%2046h28%22%20fill=%22none%22%20stroke=%22rgba(255,255,255,.85)%22%20stroke-width=%224%22%20stroke-linecap=%22round%22/%3E%20%3C/svg%3E">
  <link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABc0lEQVR42mNUTX7NgAP8Z6AuYMQmyPKf+TetLUY3F8UhLAyoDqCV5eh2MCI54A89LcdwBCwE6Gk5iiOQQ2BAAAsD8+//A2j/fxYGloEPgQF1ABMD8x8GWuHbzZYE1TAxMP9moAW+3WDLwMDAAKHxqMNWElIM7lS5w9kqbTsZGJjxpgHaJUKVzq14LYc4gIW6IXCnOABiee8GBgYWGiXCO8UBuMVhgEizSE6EdwpCID4tCMEqzsDAwKAyeTnR5pEUAndyI1GDOzcSIQ+zfNpikkKTUXnGXKKK4jvpSQhLZs5D4SOLk1ESkpYLVObMYmBghtIMDAx3UtJQ453kkpDlNwMhDLNEZcFUDDmVBVNxyhGDCYbAndh8gj5UWTyRYH7HGQX4SsK7USVwtvKyHrItIVAO4M4iyivbIZavbGegVZ3BqLS6aSAbJAPfHhgULSLGAWoVMwyaVjGsu0TvUGBEL4rp6QhGXLmAHo5gJJQLGOnZPQcAPcMjZN2vNDMAAAAASUVORK5CYII=">
  <link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABc0lEQVR42mNUTX7NgAP8Z6AuYMQmyPKf+TetLUY3F8UhLAyoDqCV5eh2MCI54A89LcdwBCwE6Gk5iiOQQ2BAAAsD8+//A2j/fxYGloEPgQF1ABMD8x8GWuHbzZYE1TAxMP9moAW+3WDLwMDAAKHxqMNWElIM7lS5w9kqbTsZGJjxpgHaJUKVzq14LYc4gIW6IXCnOABiee8GBgYWGiXCO8UBuMVhgEizSE6EdwpCID4tCMEqzsDAwKAyeTnR5pEUAndyI1GDOzcSIQ+zfNpikkKTUXnGXKKK4jvpSQhLZs5D4SOLk1ESkpYLVObMYmBghtIMDAx3UtJQ453kkpDlNwMhDLNEZcFUDDmVBVNxyhGDCYbAndh8gj5UWTyRYH7HGQX4SsK7USVwtvKyHrItIVAO4M4iyivbIZavbGegVZ3BqLS6aSAbJAPfHhgULSLGAWoVMwyaVjGsu0TvUGBEL4rp6QhGXLmAHo5gJJQLGOnZPQcAPcMjZN2vNDMAAAAASUVORK5CYII=">
  <link rel="icon" type="image/png" sizes="16x16" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAzElEQVR42mNUTX7NgAT+MxAHGGEMlv9s30jRiG4RIwsD+3cGSgALA9u3/xTo/8/EwP6dgVh8u9MQQ4yJge07AzH4dpMVAwMDA4RGEmf6z/6NARu+XeOMwoYBle7NKOqwuuBOqS8DAwMDhGZDBLLKxFUYahmVp89HCcQ7GQlYQ0tlxgKs4pgugGmYNx1VJY6wQYmFO0mZCA3s3xlUlvZBDFvahzNmGJVWNaN44W5oDYPy6haiEwKj0saq/5SmREYy8gIDFfMCxABGcrMzADuzf1sMCG6dAAAAAElFTkSuQmCC">
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAG/ElEQVR42u2d+W7cVBSHr6N5ko7zHiDEKkCAEEUNpekempSUfe8fLRIlaZuQfZ0kbSchEBAIECCxvQfmCXiI4Y9RCCXLeOZe2+ec+32SVanN2GfGn39zju24Sf/Zv50iWg6qINFSaK0l1xHklb0vREpec0kLicF3XyVyhK7eISRGbhMJjci25U6qERqRwZDYZSY0IiO2iR4akaE0sYtOaGSGg5xIihO6GOcQGSpJ61oBxwoyQ2VpHbrlQGaoVOpQLQcig4gWJERCIzOISWvfhEZmECW1z1CIzCBO6l4TGplBpNS99NDIDGKlruEnWKLbHhr7QXRKd5PQyAzipc7bQyMzqJBa2u8UAnj20J3DF+NBTUp3GgqRGVRJzWk7MNZyHN5DYzqoS2kSGqJIaCwHlSndx+cC1hOadAa1KU0PDaYTGrtBdUrX9DzKGiBPQhPKYLTlwGxQ33aQ0GB6KARQTR/tBhhqO0hosNZyEM5ADw1AQgOUkdAYDXYGQ1oOoOUAYCgEIKEBuh8KAUhoAHpoABIagB4aaDkAaDkASGiQyZ9XH9j3d/3X/lD1HvraCc0S+3KQzHuS63kfSXrtNyI65lT+6MFcP9d//XcSmkV4KueUeU98DQl9/RcSOsZk/vChnl7X//GvsofCFmc5oAuk+8JZjgjJPni49xcL94UHniOzKUjomGR+/xH/lSS0HCBB5vce9V5H+snPTvq9P1z6hq5GQgUtB7vJfDq/+5h/Ot/4yWlwhYQ2L/PjAWT+kaEQBMj8zhNhVqTIERIajk7nT39QVS8JbTWd337SX+ax7522GYsLK8h8uMwKIaGtyfzWU/4yj3/ntJ79ooc2JfPTgdak1wkSGu5P55vfOs3XJhDaSjq/8Yy/zLe+cdovtDEUIvOezAYgobXL/PqzYVZkxAOGQtUyPxemb779tZnPhISOfQic+MpZukGNhM6ThK89f4AIO+Jq6l7mHXP7KqlPfInRh0lzpbM06eSOyLok1l0GPJfjyCWvXOXVFELmNjb3WVKf3CahDxJ19IXuU++zL8TVVEWdJLSwpVdx2q+r9hujs8zbpvddn0ucY9lbstHjnil6XGRdzjmXTm2b339JfWqLlmNXxssvhj0lNv25mLpC1ULLoaXNCCzznohS6opjPyb16Wb0CZ2NnCh0/enMZqV19bp9jUR/YSUbGSjtgElnmqW/vyq2WW3LEfsgWPbBk3cIDHCgpbPN6PZn1D10NjxQ/jfC8EApdaWz96Lcp9HenJRdOlndtodfaks3d7e4uiLdr1EmdJUy75e3gIsnc3ei/dZN6nPrUR3K2SunxNWUzm8Eq213XbGS1OfjETob8hMmXdjwXkehB8ZC3DJHddouGxr0lGX9vj991xde5nUHkfzGSnbxtJ8si2v7TvGli2ve6w37XcsdDFEMhf4yNw5dd/vfBKTzETVGeNrOcDJfOBMg+TrItNQIt61eZF5qOB5aH0FChxAsXVrNvb32z5Yt8yqpHMOFlez8OX9Zlle6Tr50eSXItumbOcvxH5nPB5B52fu1IeooqkbLJPXlRTNGZ+cu+IuysiSqnqJrNNhDI3NRohQhHjJ3SuiVBfUJnZ296C/K6mL0NdrooRksXNpYKPzUV9pYcNmZIYbA4lsO5afnPCVJG/Ol1drelvw6dd9t15hVe9hnpy/5ybw2p6L2KutkKETmYNtP1+aQueuhcG1GXUJng8N+Mq3Pin8/0mrUMxQqu7CSDY54yjwjbygVWBNnOcqQ+dRlP3E2prmRh4SWIvOrnjJPsbfjSGgFMr/sKfOdKZKZhJYi82iAtXBBgh5agswnr/gPXHcnSWeEtkF6bwKZI6PPtMxAQpuQuXmbZI5V6JaxganevMVejZjkWHNctNF/nXgzv8ybN9mj9NCybwesb47nlHnccfski4oHnte3jpa6vjXO/+DFouuB5/WtsUNkHiOZWP5dkmNbN7iMBoZO23FZGEwJzS9egi2h+RCAlgOAlgOAhAaghwYSGoAeGoCEBiChAfIOhYkjpsEGCS0H0HIAMBQCkNAA3bH7XA6uF4L6gZCEBnpoAC09NOejQXW7QUKDxYTmQwCbLQdtB6huN2g5wHxCk9KgNp2dM/zAcyChSWlQnc700BBNQpPSoC6dSWiwmNAdjwSMBxXpnDehkRpUyNyphwYwNRSS0qAqnbsdCpEaRMucZyhEalAjc7cJDWCmhyalQXw6+yQ0UoM4mXvpoZEaxMocoodGahAjc689NFKDSJlDJPT/C0FsqETkkAlNWoMImX2HQqQGUTKHbDloQaBSkYtqOUhrqEzmIhOatIZSRS4roREbSn3YXK3CN4jYiKw6oREbkctI6JakDwC5kVhtQiM3EhchtKoPDMmR90j+AdYnBznKE65eAAAAAElFTkSuQmCC">
  <meta name="viewport" content="width=device-width, initial-scale=0.8, minimum-scale=0.8, maximum-scale=0.8, user-scalable=no, viewport-fit=cover" />
  <title>股票策略卡</title>
    <link rel="manifest" href="./manifest.webmanifest" />
  <meta id="metaThemeColor" name="theme-color" content="#f4f6fb" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="股票策略卡" />
<style>
    :root{
      --bg: #f4f6fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --shadow: 0 10px 25px rgba(17,24,39,.08);
      --radius: 18px;

      --green: #20c997;
      --green-2: #18b07f;
      --blue: #3b82f6;
      --red: #ef4444;


      --green-deep: #0b7a2b;
      --pill-red-bg: rgba(239,68,68,.10);
      --pill-amber-bg: rgba(245,158,11,.12);
      --pill-green-bg: rgba(16,185,129,.12);
      --pill-blue-bg: rgba(59,130,246,.12);

      --pill-red-text: #b91c1c;
      --pill-amber-text: #92400e;
      --pill-green-text: #065f46;
      --pill-blue-text: #1d4ed8;

      --divider: rgba(17,24,39,.06);
    }
    :root[data-theme="amoled"]{
      --bg: #000000;
      --card: #0b0b0b;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --shadow: none;

      --divider: rgba(255,255,255,.08);

      --pill-red-bg: rgba(239,68,68,.18);
      --pill-amber-bg: rgba(245,158,11,.18);
      --pill-green-bg: rgba(16,185,129,.16);
      --pill-blue-bg: rgba(59,130,246,.18);

      --pill-red-text: #fecaca;
      --pill-amber-text: #fde68a;
      --pill-green-text: #a7f3d0;
      --pill-blue-text: #bfdbfe;
    }

    :root[data-theme="amoled"] .overlay{
      background: rgba(0,0,0,.72);
    }

    :root[data-theme="amoled"] .dash,
    :root[data-theme="amoled"] .card{
      background: var(--card) !important;
      border-color: rgba(255,255,255,.10) !important;
      box-shadow: none !important;
      backdrop-filter: none !important;
    }

    :root[data-theme="amoled"] .modal{
      background: var(--card) !important;
      box-shadow: 0 20px 60px rgba(0,0,0,.55) !important;
    }


    /* AMOLED: improve visibility of cards + cards header */
    :root[data-theme="amoled"] .card{
      background: #101010 !important; /* slightly brighter than --bg for separation */
      border-color: rgba(255,255,255,.16) !important;
    }
    :root[data-theme="amoled"] .cards-title{
      color: rgba(229,231,235,.72);
    }
    :root[data-theme="amoled"] .cards-toggle{
      background: rgba(11,11,11,.92);
      border-color: rgba(255,255,255,.16);
      color: rgba(229,231,235,.85);
    }

    :root[data-theme="amoled"] .dash-toggle{
      background: rgba(255,255,255,.10) !important;
      box-shadow: none !important;
    }

    :root[data-theme="amoled"] .meter-track{
      background: rgba(255,255,255,.10) !important;
    }

    :root[data-theme="amoled"] .meter-invalid{
      background: rgba(255,255,255,.06) !important;
    }

    :root[data-theme="amoled"] .tool,
    :root[data-theme="amoled"] .refresh-mini{
      background: rgba(255,255,255,.06) !important;
      border-color: rgba(255,255,255,.12) !important;
    }

    :root[data-theme="amoled"] .stats-grid{
      border-top-color: rgba(255,255,255,.10) !important;
    }

    :root[data-theme="amoled"] .dp{
      border-right-color: rgba(255,255,255,.10) !important;
      border-bottom-color: rgba(255,255,255,.10) !important;
    }
    :root[data-theme="amoled"] .dp .dp-l{
      color: rgba(229,231,235,.60) !important;
    }

    :root[data-theme="amoled"] .btn2.ghost{
      background: rgba(255,255,255,.10) !important;
      color: var(--text) !important;
    }

    :root[data-theme="amoled"] .d-avg,
    :root[data-theme="amoled"] .d-dur,
    :root[data-theme="amoled"] .chg-badge.flat,
    :root[data-theme="amoled"] .status.muted{
      background: rgba(255,255,255,.08) !important;
    }

    :root[data-theme="amoled"] .dash-row:active{
      background: rgba(255,255,255,.06) !important;
    }

    :root[data-theme="amoled"] .rank-arrow.flat{
      color: rgba(229,231,235,.28) !important;
    }

    :root[data-theme="amoled"] .switch .slider{
      background: rgba(255,255,255,.14) !important;
    }

    :root[data-theme="amoled"] .title-row .code{
      color: rgba(229,231,235,.55) !important;
    }

    :root[data-theme="amoled"] .range-bracket{
      background: rgba(255,255,255,.08) !important;
      border-color: rgba(255,255,255,.14) !important;
    }

        :root[data-theme="amoled"] .meter-end .end-line{
      background: rgba(229,231,235,.22) !important;
    }
    :root[data-theme="amoled"] .meter-end .end-label{
      color: rgba(229,231,235,.65) !important;
    }

    :root[data-theme="amoled"] .meter-mark .mark-line{
      background: rgba(229,231,235,.22);
    }

    :root[data-theme="amoled"] .meter-mark .mark-chip{
      background: rgba(11,11,11,.92) !important;
      border-color: rgba(255,255,255,.12) !important;
    }
    :root[data-theme="amoled"] .meter-mark .mark-chip .chip-l{
      color: rgba(229,231,235,.65) !important;
    }

        :root[data-theme="amoled"] .meter-cursor:not(.up):not(.down) .dot{
      background: rgba(255,255,255,.55) !important;
    }

    :root[data-theme="amoled"] .meter-cursor:not(.up):not(.down) .tri{
      border-top-color: rgba(229,231,235,.70);
    }

*{ box-sizing: border-box; }
    html,body{ height:100%; overflow-x: hidden; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
      overscroll-behavior-x: none;
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app{
      max-width: 520px;
      margin: 0 auto;
      padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
    }

    /* Header row: title on left, actions on right (two rows) */
    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      padding: 8px 4px 14px 4px;
    }
    .title-wrap{ flex: 1; min-width: 0; }
    .title{
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .2px;
      margin: 6px 0 2px 0;
    }
    .subtitle{
      font-size: 14px;
      color: var(--muted);
      margin: 0;
      line-height: 1.5;
    }

    /* Brand (vector) */
    .title{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .logo{
      display:inline-flex;
      width: 22px;
      height: 22px;
      flex: 0 0 auto;
      border-radius: 8px;
      overflow:hidden;
      box-shadow: 0 6px 16px rgba(17,24,39,.10);
    }
    .title-text{
      display:inline-block;
      min-width: 0;
    }


    .header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 8px 4px 10px 4px;
      flex-wrap: nowrap;
    }
    .header-row .title-wrap{
      padding: 0;
      flex: 1 1 auto;
      min-width: 0;
    }
    .actions.actions-side{
      flex: 0 0 auto;
      display:flex;
      flex-direction:row;
      gap: 10px;
      padding: 2px 0 0 0;
      margin-left: auto;
      width: auto;
      max-width: none;
    }
    .actions.actions-side .btn{
      width: auto;
      justify-content:center;
      padding: 12px 14px;
      border-radius: 18px;
      white-space: nowrap;
    }

    /* keep comfortable layout on very small screens */
    @media (max-width: 360px){
      .actions.actions-side .btn{
        padding: 11px 10px;
      }
    }


    .actions{
      display:flex;
      flex-direction:column;
      gap: 10px;
      flex: 0 0 auto;
      width: 168px;
      padding-top: 6px;
    }
    .btn{
      border: 0;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight: 800;
      font-size: 15px;
      display:flex;
      align-items:center;
      gap: 10px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(17,24,39,.08);
      color: #fff;
      justify-content:center;
      width: 100%;
      white-space: nowrap;
    }
    .btn.green{ background: linear-gradient(180deg, var(--green), var(--green-2)); }
    .btn.blue{ background: linear-gradient(180deg, #4f8cff, var(--blue)); }
    .btn:active{ transform: translateY(1px); }

    .list{ padding: 0 4px 24px 4px; }

    /* Dashboard panel (top summary) */
    .dash{
      margin: 0 4px 10px 4px;
      padding: 12px 12px 10px 12px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(255,255,255,.6);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .dash-hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .dash-title{
      display:flex;
      align-items:baseline;
      gap: 8px;
      min-width: 0;
      font-size: clamp(15px, 4.1vw, 17px);
      font-weight: 900;
      letter-spacing: .2px;
    }
    .dash-summary{
      font-size: clamp(12px, 3.4vw, 14px);
      color: var(--muted);
      font-weight: 850;
      white-space: nowrap;
    }
    .dash-toggle{
      border: 0;
      background: rgba(17,24,39,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 6px;
      box-shadow: 0 10px 20px rgba(17,24,39,.06);
    }
    .dash-toggle:active{ transform: translateY(1px); }
    .dash-bd{ margin-top: 8px; display:block; }
    .dash.collapsed .dash-bd{ display:none; }

    /* Cards header (bulk collapse/expand) */
    .cards-hd{
      margin: 14px 0; /* spacer between dashboard and cards (vertical centering) */
      display:flex;
      align-items:center;
      justify-content: flex-start;
      position: relative;
      min-height: 56px;
    }
    .cards-title{
      font-size: 14px;
      font-weight: 950;
      color: var(--muted);
      letter-spacing: .2px;
    }
    .cards-toggle{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(17,24,39,.10);
      background: #fff;
      color: rgba(17,24,39,.72);
      font-weight: 900;
      cursor:pointer;
      user-select:none;

      /* Center in the gap row (both X and Y) */
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    .cards-toggle:active{ transform: translate(-50%, -50%) translateY(1px); }
    .cards-toggle:disabled{ opacity: .5; cursor: not-allowed; }
    .cards-toggle svg{ width: 18px; height: 18px; transition: transform .15s ease; }
    .cards-toggle.collapsed svg{ transform: rotate(180deg); }


    .dash-section{ margin-top: 10px; }
    .dash-section:first-child{ margin-top: 0; }

    .dash-table{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: clamp(12.5px, 3.45vw, 14.5px);
    }
    .dash-table th,
    .dash-table td{
      box-sizing: border-box;
      padding: 9px 7px;
      border-top: 1px solid var(--divider);
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .dash-table th{
      color: var(--muted);
      font-weight: 900;
      border-top: 0;
    }
    .dash-table tbody tr:nth-child(odd){ background: rgba(17,24,39,.02); }

    .dash-table td.num,
    .dash-table th.num{ text-align: right; }

    .d-tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 5px 9px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12px;
      line-height: 1;
      border: 1px solid rgba(17,24,39,.08);
    }
    .d-stop{ background: var(--pill-red-bg); color: var(--pill-red-text); }
    .d-break{ background: var(--pill-blue-bg); color: var(--pill-blue-text); }
    .d-avg{ background: rgba(17,24,39,.06); color: var(--muted); }

    .d-dur{ background: rgba(17,24,39,.06); color: var(--text); }
    .d-tags{ display:inline-flex; align-items:center; gap:6px; }
    .dash-row{ cursor:pointer; }
    .dash-row:active{ background: rgba(17,24,39,.04); }
    .dash-table td.stock{ padding-left: 12px; white-space: normal; line-height: 1.2;  font-weight: 950; text-overflow: clip; }


    /* Strong table (均价上方列表): tighten spacing to avoid right overflow */
    /* Strong table: tighten spacing & prevent right overflow (dashboard only) */
.dash-strong th, .dash-strong td{ padding: 8px 5px; }
.dash-strong td.stock{ padding-right: 2px; white-space: nowrap; }
.dash-strong th.num, .dash-strong td.num{ padding-left: 2px; }
.dash-strong td:last-child{ padding-right: 4px; } /* ensure right padding doesn't push outside */
.dash-strong .d-tag{ max-width: 100%; box-sizing: border-box; }




/* Rank change arrow for Strong board (dashboard only) */
.rank-arrow{
  display:inline-block;
  width: 12px;
  margin-right: 4px;
  text-align: center;
  font-weight: 950;
  line-height: 1;
  flex: 0 0 auto;
}
.rank-arrow.up{ color: var(--red); }
.rank-arrow.down{ color: var(--green-deep); }
.rank-arrow.flat{ color: rgba(17,24,39,.18); }

/* Dashboard stock cell layout: align Name + Code (left-aligned).
       - Strong list keeps an arrow column (placeholder is invisible for “no change”).
       - Triggered list removes the arrow column entirely to avoid truncation. */
    .dash-stock{
      display: grid;
      grid-template-columns: 12px minmax(0, 1fr) 6ch;
      align-items: center;
      column-gap: 6px;
      width: 100%;
      max-width: 100%;
    }
    .dash-stock.noarrow{
      grid-template-columns: minmax(0, 1fr) 6ch;
    }
    .dash-stock.noarrow .rank-arrow{ display:none; }

    /* Hide placeholder arrows but keep the column width */
    .rank-arrow.placeholder{ opacity: 0; }

    /* Avoid ellipsis for Chinese names; allow wrapping when tight */
    .dash-stock .dash-name{
      overflow: visible;
      text-overflow: clip;
      white-space: normal;
    }
    .dash-stock .dash-code{
      font-variant-numeric: tabular-nums;
      letter-spacing: .2px;
      text-align: left;
      justify-self: start;
      white-space: nowrap;
    }
    .rank-arrow.placeholder{ color: transparent; }
    .dash-empty{
      padding: 10px 7px;
      color: var(--muted);
      font-weight: 850;
      font-size: clamp(12.5px, 3.45vw, 14px);
      border-top: 1px solid var(--divider);
    }


    .card{
      font-variant-numeric: tabular-nums;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.6);
      margin-bottom: 10px;
    }
    .card-inner{ padding: 10px; }
    /* Card collapse (like dashboard): keep header visible, hide the body */
    .card-bd{ display:block; }
    .card.collapsed .card-bd{ display:none; }
    .tool.collapse svg{ transition: transform .15s ease; transform-origin: 50% 50%; }
    .card:not(.collapsed) .tool.collapse svg{ transform: rotate(180deg); }

    .card-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .codes{ flex: 1 1 auto; min-width: 0; }

    /* Title row: Name + Change badge (Template A) */
    .title-row{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .title-row .big{
      /* keep code close to name (avoid pushing it to the far right) */
      flex: 0 1 auto;
      min-width: 0;
      max-width: calc(100% - 72px);
    }
    .title-row .code{
      flex: 0 0 auto;
      font-size: 13px;
      font-weight: 850;
      color: rgba(17,24,39,.55);
      letter-spacing: .2px;
      white-space: nowrap;
    }

    .codes .big{
      font-size: 20px;
      font-weight: 900;
      letter-spacing: .2px;
      margin:0;
      line-height: 1.15;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }
    .codes .small{
      margin: 4px 0 0 0;
      font-size: 12px;
      color: var(--muted);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }

    .chg-badge{
      position: static;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 16px;
      letter-spacing: .1px;
      white-space: nowrap;
      min-width: 64px;
      line-height: 1;
      background: rgba(17,24,39,.06);
      color: var(--muted);
      flex: 0 0 auto;
    }
    .chg-badge.up{ background: rgba(239,68,68,.10); color: var(--red); }
    .chg-badge.down{ background: rgba(16,185,129,.12); color: var(--green-deep); }
    .chg-badge.flat{ background: rgba(17,24,39,.06); color: var(--muted); }


    /* Note bar (备注) — Template A: full-width horizontal bar */
    .note-row{ margin-top: 8px; }
    .card-note{
      width: 100%;
      min-height: 36px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid rgba(17,24,39,.08);
      background: rgba(17,24,39,.04);
      color: var(--text);
      font-size: 12px;
      line-height: 1.2;
      display:flex;
      align-items:center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .card-note{ cursor: pointer; }
    .card-note.expanded{
      border-radius: 16px;
      display: block;
      padding: 10px 12px;
      min-height: unset;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
    }
    .card-note .note-ph{
      color: var(--muted);
      font-weight: 850;
    }

    .card-tools{
      display:flex;
      gap:8px;
      flex: 0 0 auto;
    }
    .tool{
      width: 30px;
      height: 30px;
      border-radius: 12px;
      border: 1px solid rgba(17,24,39,.08);
      background: rgba(255,255,255,.8);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .tool:active{ transform: translateY(1px); }
    .header-gear{ width: 36px; height: 36px; border-radius: 14px; }
    .header-gear svg{ width: 18px; height: 18px; }
    .tool.danger{
      border-color: rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
    }

    /* Manual reordering mode */
    .tool.sort-only{ display:none; }
    body.sort-mode .tool.sort-only{ display:inline-flex; }
    body.sort-mode .card-tools .tool:not(.sort-only){ display:none; }
    body.sort-mode .card{ border-style: dashed; border-color: rgba(59,130,246,.30); }

.price-row{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      margin-top: 8px;
      gap: 12px;
    }
    .price-left .label{
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px 0;
    }
    .price-left .price{
      display:flex;
      font-variant-numeric: tabular-nums;
      align-items:center;
      gap: 8px;
      margin:0;
      font-size: 29px;
      font-weight: 950;
      color: var(--text);
      letter-spacing: .2px;
      line-height: 1;
    }

    .price-left .price .price-value{
      color: var(--text);
    }
    .price-left .price .price-value.up{
      color: var(--red);
    }
    .price-left .price .price-value.down{
      color: var(--green-deep);
    }
    .price-left .price .price-value.flat{
      color: var(--text);
    }
    .refresh-mini{
      width: 32px;
      height: 32px;
      border-radius: 12px;
      border: 1px solid rgba(17,24,39,.08);
      background: rgba(255,255,255,.85);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .refresh-mini:active{ transform: translateY(1px); }


    .price-mid{
      flex: 0 1 250px;
      max-width: 260px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px 12px;
      align-content:start;
      justify-items:start;
      padding: 0 2px 0 2px;
      min-width: 0;
      margin-left: auto;       /* push metrics + right block to the right */
      align-self: flex-start;  /* move to upper area */
      margin-top: -2px;        /* nudge up slightly for compactness */
    }
    .metric{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 0;
    }
    .metric .m-label{
      font-size: 11px;
      color: var(--muted);
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .metric .m-val{
      font-size: 13px;
      font-weight: 900;
      color: var(--text);
      line-height: 1.15;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .metric .m-val.avg-up{ color: var(--red); }
    .metric .m-val.avg-down{ color: var(--green-deep); }
    .metric .m-val.avg-flat{ color: var(--text); }

    /* keep right block aligned to top when metrics exists */
    .price-right{ align-self:flex-start; }

    @media (max-width: 420px){
      .price-mid{
        flex-basis: 225px;
        max-width: 235px;
        gap: 6px 10px;
      }
      .metric .m-val{ font-size: 12.5px; }
    }

    .price-right{
      text-align:right;
      min-width: 96px;
    }
        .status{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      font-weight: 850;
      font-size: 12px;
      padding: 7px 9px;
      border-radius: 12px;
      margin-bottom: 6px;
      white-space:nowrap;
      background: var(--pill-amber-bg);
      color: var(--pill-amber-text);
    }
    .status.red{ background: var(--pill-red-bg); color: var(--pill-red-text); }
    .status.amber{ background: var(--pill-amber-bg); color: var(--pill-amber-text); }
    .status.blue{ background: var(--pill-blue-bg); color: var(--pill-blue-text); }
    .status.green{ background: var(--pill-green-bg); color: var(--pill-green-text); }
    .status.muted{ background: rgba(17,24,39,.06); color: var(--muted); }
    .time{
      font-size: 12px;
      color: var(--muted);
    }

    .divider{
      height: 1px;
      background: var(--divider);
      margin: 10px -10px 10px -10px;
    }

    /* Pills on one row: 4 cols by default; 5 cols when TP2 exists */
    .pills{
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(4, 1fr);
    }
    .pills.cols-3{ grid-template-columns: repeat(3, 1fr); }
    .pills.cols-5{ grid-template-columns: repeat(5, 1fr); }

    .pill{
      display:flex;
      flex-direction:column;
      gap: 2px;
      padding: 7px 10px;
      border-radius: 14px;
      min-width: 0;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .pill .k{
      font-size: clamp(12px, 2.6vw, 15px);
      font-weight: 850;
      line-height: 1.05;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .pill .v{
      font-size: clamp(14px, 3.3vw, 20px);
      font-weight: 950;
      font-variant-numeric: tabular-nums;
      letter-spacing: .2px;
      line-height: 1.05;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .pill .d{
      font-size: 11px;
      font-weight: 850;
      line-height: 1.05;
      opacity: .85;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    .pills.cols-5 .pill .v{
      font-size: clamp(13px, 3.0vw, 18px);
    }
    .pill.red{ background: var(--pill-red-bg); color: var(--pill-red-text); }
    .pill.amber{ background: var(--pill-amber-bg); color: var(--pill-amber-text); }
    .pill.green{ background: var(--pill-green-bg); color: var(--pill-green-text); }
    .pill.blue{ background: var(--pill-blue-bg); color: var(--pill-blue-text); }

    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px 18px calc(18px + env(safe-area-inset-bottom));
      z-index: 50;
    }
    .overlay.show{ display:flex; }
    #alertOverlay{ align-items:center; }


    /* Stock edit/add overlay: pin modal to top so keyboard is less likely to cover it */
    #overlay{
      align-items:flex-start;
      padding-top: calc(18px + env(safe-area-inset-top));
    }
    #overlay .modal{
      margin-top: 0;
    }


    .modal{
      width: min(520px, 100%);
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 20px 60px rgba(17,24,39,.25);
      overflow:hidden;
      max-height: calc(100dvh - 44px);
      display:flex;
      flex-direction: column;
    }
    .modal-hd{
      padding: 14px 16px;
      border-bottom: 1px solid var(--divider);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .modal-hd h3{
      margin:0;
      font-size: 16px;
      font-weight: 900;
    }

    /* Threshold alert title: colored status tag */
    #alertTitle{
      display:flex;
      align-items:baseline;
      gap: 8px;
      flex-wrap: wrap;
    }
    #alertTitle .alert-tag{
      font-weight: 950;
      letter-spacing: .1px;
      white-space: nowrap;
    }
    #alertTitle .alert-stop{ color: var(--pill-red-text); }
    #alertTitle .alert-breakout{ color: var(--pill-blue-text); }
    #alertTitle .alert-tp1{ color: var(--pill-green-text); }
    #alertTitle .alert-tp2{ color: var(--pill-green-text); }
    .modal-bd{
      padding: 14px 16px 6px 16px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Make form single-column for phones */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    /* Threshold inputs: 3 + 2 compact layout (desktop/mobile), fallback to single-column on very small screens */
    .grid.grid-thresh{
      grid-template-columns: repeat(6, minmax(0,1fr));
    }
    .grid.grid-thresh .field{ margin-bottom: 0; }
    .grid.grid-thresh .field:nth-child(1),
    .grid.grid-thresh .field:nth-child(2),
    .grid.grid-thresh .field:nth-child(3){ grid-column: span 2; }
    .grid.grid-thresh .field:nth-child(4),
    .grid.grid-thresh .field:nth-child(5){ grid-column: span 3; }
    @media (max-width: 380px){
      .grid.grid-thresh{ grid-template-columns: 1fr; }
      .grid.grid-thresh .field{ grid-column: auto; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-bottom: 10px;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 750;
    }
    input{
      border: 1px solid rgba(17,24,39,.12);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
    }
    input:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.10);
    }

    /* Toggle switch (for background refresh option) */
    .switch{
      position: relative;
      display: inline-block;
      width: 46px;
      height: 26px;
      flex: 0 0 auto;
    }
    .switch input{ display:none; }
    .switch .slider{
      position: absolute;
      inset: 0;
      border-radius: 999px;
      background: rgba(17,24,39,.14);
      transition: .18s ease;
    }
    .switch .slider:before{
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      left: 3px;
      top: 3px;
      border-radius: 999px;
      background: #fff;
      box-shadow: 0 8px 18px rgba(17,24,39,.20);
      transition: .18s ease;
    }
    .switch input:checked + .slider{
      background: rgba(11,122,43,.32);
    }
    .switch input:checked + .slider:before{
      transform: translateX(20px);
    }
    .modal-ft{
      padding: 12px 16px 16px 16px;
      display:flex;
      gap: 10px;
    }
    .btn2{
      flex:1;
      border-radius: 16px;
      border:0;
      padding: 12px 14px;
      font-weight: 900;
      cursor:pointer;
    }
    .btn2.ghost{
      background: rgba(17,24,39,.06);
      color: var(--text);
    }
    .btn2.primary{
      background: linear-gradient(180deg, #4f8cff, var(--blue));
      color: #fff;
    }

    @media (max-width: 420px){
      .actions{ width: 150px; }
      .btn{ font-size: 14px; padding: 11px 12px; }
      .codes .big{ max-width: 240px; }
      .codes .small{ max-width: 240px; }
    }
    @media (max-width: 360px){
      .actions{ width: 138px; }
      .codes .big{ max-width: 210px; }
      .codes .small{ max-width: 210px; }
    }

    svg{ width:18px; height:18px; }
  
    /* ===== Template A++ (Modern): Core price + Visual Meter ===== */
    .core-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap: 12px;
      margin-top: 8px;
    }
    .core-left{ min-width: 0; }
    .core-left .label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 750;
      margin-bottom: 4px;
    }
    .core-line{
      display:flex;
      align-items:baseline;
      gap: 10px;
      min-width: 0;
    }
    .core-price{
      font-size: 28px;
      font-weight: 950;
      letter-spacing: -0.4px;
      line-height: 1;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    .core-price.up{ color: var(--red); }
    .core-price.down{ color: var(--green-deep); }
    .core-price.flat{ color: var(--text); }

    .core-change{
      font-size: 16px;
      font-weight: 900;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    .core-change.up{ color: var(--red); }
    .core-change.down{ color: var(--green-deep); }
    .core-change.flat{ color: var(--muted); }

    .updated-row{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .core-right{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap: wrap;
      align-self: center;
    }
    .core-right .updated-row{
      margin-top: 0;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: 999px;
      font-weight: 850;
      font-size: 12px;
      white-space: nowrap;
      background: var(--pill-amber-bg);
      color: var(--pill-amber-text);
    }
    .status-pill.red{ background: var(--pill-red-bg); color: var(--pill-red-text); }
    .status-pill.amber{ background: var(--pill-amber-bg); color: var(--pill-amber-text); }
    .status-pill.blue{ background: var(--pill-blue-bg); color: var(--pill-blue-text); }
    .status-pill.green{ background: var(--pill-green-bg); color: var(--pill-green-text); }

    .pulse-dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: currentColor;
      opacity: .9;
      box-shadow: 0 0 0 0 rgba(17,24,39,.0);
      animation: pulse 1.4s infinite;
      flex: 0 0 auto;
    }
    @keyframes pulse{
      0%   { transform: scale(0.9); opacity: .75; box-shadow: 0 0 0 0 rgba(17,24,39,.00); }
      70%  { transform: scale(1.12); opacity: 1;  box-shadow: 0 0 0 8px rgba(17,24,39,.06); }
      100% { transform: scale(0.9); opacity: .75; box-shadow: 0 0 0 0 rgba(17,24,39,.00); }
    }

    /* Visual meter */
    .meter-wrap{
      position: relative;
      margin-top: 16px;
      padding: 24px 8px 34px; /* top right bottom left: extra bottom space for end labels */
      --meter-pad: 6; /* % per side: invalid zone padding */
    }
    .meter-track{
      height: 8px;
      background: rgba(17,24,39,.08);
      border-radius: 999px;
      position: relative;
      overflow: hidden;
    }

    .meter-invalid{
      position:absolute;
      top:0;
      height:100%;
      width: calc(var(--meter-pad) * 1%);
      background: rgba(17,24,39,.06);
      pointer-events:none;
      z-index: 0;
    }
    .meter-invalid.left{ left:0; border-radius: 999px 0 0 999px; }
    .meter-invalid.right{ right:0; border-radius: 0 999px 999px 0; }


    /* Intraday low-high bracket (冖): visualizes today's range above the meter */
    .range-bracket-layer{
      position: absolute;
      left: 8px;
      right: 8px;
      top: 0px;
      height: 12px;
      pointer-events: none;
      z-index: 3;
    }
    .range-bracket{
      position: absolute;
      top: 2px;
      height: 8px;
      border-radius: 999px;
      background: rgba(17,24,39,.12);
      border: 1px solid rgba(17,24,39,.14);
    }
    .range-avg-tick{
      position:absolute;
      top: 1px;
      width: 3px;
      height: 10px;
      border-radius: 999px;
      background: rgba(245,158,11,.92);
      box-shadow: 0 0 0 1px rgba(17,24,39,.10);
      z-index: 4;
      transform: translateX(-50%);
      pointer-events: none;
    }
    .meter-fill{
      position:absolute;
      left:0;
      top:0;
      height:100%;
      border-radius: 999px;
      opacity: .22;
      z-index: 1;
    }
    .meter-fill.up{ background: var(--red); }
    .meter-fill.down{ background: var(--green-deep); }
    .meter-fill.flat{ background: rgba(17,24,39,.30); }

    /* --- Tighter endpoints: move labels up and pin to both sides --- */
    .meter-end{
      position: absolute;
      top: auto;    /* unpin from top */
      bottom: 4px;  /* pin to container bottom */
      display: flex;
      flex-direction: column;
      gap: 1px;
      pointer-events: none;
      z-index: 1; /* keep below floating marks */
      background: transparent;
      padding: 0;
      border-radius: 4px;
    }

    .meter-end.left{
      left: 0 !important;
      transform: none !important;
      align-items: flex-start;
    }

    .meter-end.right{
      right: 0 !important;
      left: auto !important;
      transform: none !important;
      align-items: flex-end;
    }

    /* Hide the original stem line (tick is no longer meaningful once pinned to sides) */
    .meter-end .end-line{ display: none; }

    .meter-end .end-label{
      font-size: 10px;
      color: rgba(17,24,39,.45);
      font-weight: 700;
      margin-bottom: 0;
      line-height: 1.2;
    }

    .meter-end .end-val{
      font-size: 12px;
      font-weight: 900;
      line-height: 1.1;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    .meter-end .end-val.risk{ color: var(--pill-red-text); }
    .meter-end .end-val.profit{ color: var(--pill-green-text); }
    .meter-end .end-val.neutral{ color: var(--text); opacity: .92; }

    .meter-mark{
      position:absolute;
      transform: translateX(-50%);
      display:flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      top: 14px;
      z-index: 2;
    }
    .meter-mark[data-row="1"]{ top: 2px; }
    .meter-mark .mark-line{
      width: 4px;
      height: 16px;
      border-radius: 999px;
      background: rgba(17,24,39,.25);
    }
    .meter-mark.amber .mark-line{ background: rgba(245,158,11,.55); }
    .meter-mark.blue  .mark-line{ background: rgba(59,130,246,.55); }
    .meter-mark.green .mark-line{ background: rgba(16,185,129,.55); }

    .meter-mark .mark-chip{
      display:flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      padding: 5px 8px;
      border-radius: 14px;
      background: rgba(255,255,255,.82);
      border: 1px solid rgba(17,24,39,.10);
      max-width: 96px;
      min-width: 64px;
      overflow: hidden;
    }
    .meter-mark .mark-chip .chip-l{
      font-size: 11px;
      font-weight: 850;
      color: rgba(17,24,39,.62);
      line-height: 1.05;
      white-space: nowrap;
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .meter-mark .mark-chip .chip-v{
      font-size: 12px;
      font-weight: 950;
      color: var(--text);
      line-height: 1.05;
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }
    .meter-mark.compact .mark-chip{ display:none; }

    /* --- Meter mark side-split (L/R/T) to reduce overlap --- */
    .meter-mark{
      transition: left 0.3s ease;
    }
    .meter-mark .mark-chip{
      transition: transform 0.2s ease;
    }

    .meter-mark[data-side="C"] .mark-chip{ transform: translateX(0); }

    /* Shift chip to the left / right of the stem when crowded */
    .meter-mark[data-side="L"]{ align-items: flex-end; }
    .meter-mark[data-side="L"] .mark-chip{
      transform: translateX(-40%);
      border-bottom-right-radius: 0;
    }

    .meter-mark[data-side="R"]{ align-items: flex-start; }
    .meter-mark[data-side="R"] .mark-chip{
      transform: translateX(40%);
      border-bottom-left-radius: 0;
    }

    /* 3-chain crowding: middle one goes above */
    .meter-mark[data-side="T"]{
      z-index: 10;
      top: 0px;
    }
    .meter-mark[data-side="T"] .mark-line{ height: 22px; }
    .meter-mark[data-side="T"] .mark-chip{
      transform: translateY(-100%);
      box-shadow: 0 -2px 5px rgba(0,0,0,0.08);
    }

    .meter-cursor{
      position:absolute;
      top: 0px;
      transform: translateX(-50%);
      display:flex;
      flex-direction: column;
      align-items: center;
      z-index: 5;
      transition: left .45s ease;
      pointer-events: none;
    }
    .meter-cursor .tri{
      width:0;height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:8px solid rgba(17,24,39,.45);
    }
    .meter-cursor.up .tri{ border-top-color: var(--red); }
    .meter-cursor.down .tri{ border-top-color: var(--green-deep); }

    .meter-cursor .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-top: -2px;
      box-shadow: 0 1px 6px rgba(0,0,0,.10);
      border: 3px solid rgba(255,255,255,.95);
      background: rgba(17,24,39,.55);
    }
    .meter-cursor.up .dot{ background: var(--red); }
    .meter-cursor.down .dot{ background: var(--green-deep); }

    .meter-cursor .bubble{
      display: none;

      margin-top: 8px;
      font-size: 12px;
      font-weight: 950;
      color: #fff;
      padding: 4px 8px;
      border-radius: 10px;
      font-variant-numeric: tabular-nums;
      box-shadow: 0 1px 6px rgba(0,0,0,.10);
      background: rgba(17,24,39,.55);
      white-space: nowrap;
    }
    .meter-cursor.up .bubble{ background: var(--red); }
    .meter-cursor.down .bubble{ background: var(--green-deep); }

    /* Stats grid (4 columns) */
    .stats-grid{
      margin-top: 8px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 0;
      padding-top: 6px;
      border-top: 1px solid rgba(17,24,39,.06);
    }
    .dp{
      display:flex;
      align-items: baseline;
      justify-content: flex-start;
      gap: 6px;
      min-width: 0;
      padding: 3px 8px;
      border-right: 1px solid rgba(17,24,39,.06);
      border-bottom: 1px solid rgba(17,24,39,.06);
    }
    .dp:nth-child(3n){ border-right: 0; }
    .dp:nth-last-child(-n+3){ border-bottom: 0; }
    .dp .dp-l{
      font-size: 12px;
      color: rgba(17,24,39,.62);
      font-weight: 750;
      white-space: nowrap;
      line-height: 1.2;
    }
    .dp .dp-v{
      margin-top: 0;
      font-size: 13px;
      font-weight: 950;
      line-height: 1.2;
      font-variant-numeric: tabular-nums;
      color: var(--text);
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: left;
    }
    .dp.span2{ grid-column: span 2; }

    @media (max-width: 420px){
      .core-price{ font-size: 26px; }
      .meter-mark .mark-chip{ max-width: 104px; }
    }

  </style>
</head>
<body>
  <div class="app">
    


    <div class="header">
      <div class="header-row">
    <div class="title-wrap">
      <div class="title"><span class="logo" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="22" height="22" focusable="false">
          <defs>
            <linearGradient id="lg" x1="0" x2="1" y1="1" y2="0">
              <stop offset="0" stop-color="#2563eb"/>
              <stop offset="1" stop-color="#22c55e"/>
            </linearGradient>
          </defs>
          <rect x="6" y="8" width="52" height="48" rx="14" fill="url(#lg)"/>
          <path d="M18 41l10-12 8 9 12-18" fill="none" stroke="#fff" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span><span class="title-text">股票策略卡</span></div>
      <p class="subtitle">多股票决策辅助工具</p>
    </div>

    <div class="actions actions-side">
      <button class="btn green" id="btnUpdateAll" type="button">
        <span style="display:inline-flex;align-items:center;gap:10px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 0 1-15.3 6.4"></path>
            <path d="M3 12a9 9 0 0 1 15.3-6.4"></path>
            <path d="M3 3v6h6"></path>
            <path d="M21 21v-6h-6"></path>
          </svg>
          全部更新
        </span>
      </button>
      <button class="btn blue" id="btnSort" type="button">排序</button>
      <button class="btn blue" id="btnAdd" type="button">+ 添加</button>
          <button class="tool header-gear" id="btnIO" type="button" aria-label="数据导入导出" title="数据导入/导出">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 15.75a3.75 3.75 0 1 0 0-7.5 3.75 3.75 0 0 0 0 7.5Z"></path>
          <path d="M19.5 12a7.5 7.5 0 0 0-.06-.93l1.7-1.32-1.5-2.6-2 .8a7.53 7.53 0 0 0-1.61-.93l-.3-2.13H8.27l-.3 2.13c-.57.22-1.11.53-1.61.93l-2-.8-1.5 2.6 1.7 1.32A7.5 7.5 0 0 0 4.5 12c0 .31.02.62.06.93l-1.7 1.32 1.5 2.6 2-.8c.5.4 1.04.71 1.61.93l.3 2.13h5.46l.3-2.13c.57-.22 1.11-.53 1.61-.93l2 .8 1.5-2.6-1.7-1.32c.04-.31.06-.62.06-.93Z"></path>
        </svg>
      </button>
</div>
  </div>
    </div>

    <div class="dash" id="dashboard" hidden>
      <div class="dash-hd">
        <div class="dash-title">
          <span>看板</span>
          <span class="dash-summary" id="dashSummary"></span>
        </div>
        <button class="dash-toggle" id="dashToggle" type="button" aria-label="Toggle dashboard">
          <span id="dashToggleText">收起</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M6 9l6 6 6-6"></path>
          </svg>
        </button>
      </div>
      <div class="dash-bd" id="dashBody"></div>
    </div>

    <div class="cards-hd" id="cardsHeader">
      <button class="cards-toggle" id="cardsToggle" type="button" aria-label="全部折叠" title="全部折叠">
        <span id="cardsToggleText">全部折叠</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M6 9l6 6 6-6"></path>
        </svg>
      </button>
    </div>

    <div class="list" id="list"></div>
  </div>

  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-hd">
        <h3 id="modalTitle">添加股票</h3>
        <button class="tool" id="btnClose" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6L6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="modal-bd">
        <div class="field">
          <label>股票代码（6 位，如 000001 / 600000 / 430047）</label>
          <input id="fSymbol" inputmode="numeric" placeholder="000001" maxlength="12"  autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
        </div>

        <div class="field">
          <label>备注（可选）</label>
          <input id="fNote" placeholder="写下计划/逻辑/风险点（可选）" maxlength="80"  autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
        </div>

        <div class="grid grid-thresh">
          <div class="field">
            <label>止损</label>
            <input id="fStop" inputmode="decimal" placeholder="12.00"  autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
          </div>
          <div class="field">
            <label>支撑</label>
            <input id="fSupport" inputmode="decimal" placeholder="14.00"  autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
          </div>
          <div class="field">
            <label>突破位（可选）</label>
            <input id="fBreakout" inputmode="decimal" placeholder="16.00"  autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
          </div>
          <div class="field">
            <label>止盈1</label>
            <input id="fTp1" inputmode="decimal" placeholder="19.00"  autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
          </div>
          <div class="field">
            <label>止盈2（可选）</label>
            <input id="fTp2" inputmode="decimal" placeholder="22.00"  autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
          </div>
        </div>
      </div>

      <div class="modal-ft">
        <button class="btn2 ghost" id="btnCancel">取消</button>
        <button class="btn2 primary" id="btnSave">保存</button>
      </div>
    </div>
  </div>
  <!-- Import/Export Overlay -->
  <div class="overlay" id="ioOverlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-hd">
        <h3>数据管理</h3>
        <button class="tool" id="btnIOClose" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6L6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="modal-bd">
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
          <button class="btn blue" id="btnExport" type="button">导出</button>
          <button class="btn green" id="btnImport" type="button">导入</button>
        </div>

        <div style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div style="min-width:0;">
            <div style="font-weight:900;">后台继续刷新</div>
            <div style="margin-top:2px;color:var(--muted);font-size:12px;line-height:1.35;">
              开启后：页面切到后台也会尝试刷新（移动端可能仍会被系统限速/暂停）。
            </div>
          </div>
          <label class="switch" title="后台继续刷新">
            <input type="checkbox" id="bgRefreshToggle" />
            <span class="slider"></span>
          </label>
        </div>

        <div style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div style="min-width:0;">
            <div style="font-weight:900;">阈值弹窗通知</div>
            <div style="margin-top:2px;color:var(--muted);font-size:12px;line-height:1.35;">
              当现价触发止损位/突破位时弹窗提醒（仅弹一次，直到你修改对应价位）。
            </div>
          </div>
          <label class="switch" title="阈值弹窗通知">
            <input type="checkbox" id="alertToggle" />
            <span class="slider"></span>
          </label>
        </div>


        <div style="margin-top:12px;display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div style="min-width:0;">
            <div style="font-weight:900;">夜间模式（AMOLED）</div>
            <div style="margin-top:2px;color:var(--muted);font-size:12px;line-height:1.35;">
              纯黑背景；更省电/更护眼（未手动选择时可跟随系统深色模式）。
            </div>
          </div>
          <label class="switch" title="夜间模式（AMOLED）">
            <input type="checkbox" id="amoledToggle" />
            <span class="slider"></span>
          </label>
        </div>

        <input id="ioFile" type="file" accept="application/json,.json" style="display:none" />
        <div style="margin-top:10px;color:var(--muted);font-size:12px;line-height:1.5;">
          导出会下载 JSON 文件；导入会覆盖当前股票列表（本地缓存）。
        </div>
      </div>
    </div>
  </div>


  <!-- Threshold Alert Overlay -->
  <div class="overlay" id="alertOverlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-hd">
        <h3 id="alertTitle">提醒</h3>
      </div>
      <div class="modal-bd">
        <div id="alertBody" style="line-height:1.55;font-size:14px;"></div>
      </div>
      <div class="modal-ft">
        <button class="btn2 primary" id="btnAlertOk" type="button">确认</button>
      </div>
    </div>
  </div>


  <script>
    // ---------- Data Layer ----------
    const LS_KEY = "strategy_cards_frontend_only_v3";
    const LS_DRAFT_KEY = "strategy_cards_form_draft_v2";
    const LS_BG_REFRESH_KEY = "strategy_cards_bg_refresh_v1";
    const LS_DAY_KEY = "strategy_cards_last_seen_day_v1";

    const METER_PAD_PCT = 6; // % per side for meter invalid zones

    const LS_THEME_KEY = "strategy_cards_theme_v1";
    const THEME_LIGHT = "light";
    const THEME_AMOLED = "amoled";
    const META_THEME_LIGHT = "#f4f6fb";
    const META_THEME_AMOLED = "#000000";
    let activeTheme = THEME_LIGHT;

    function setMetaThemeColor(color){
      const meta = document.getElementById("metaThemeColor") || document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute("content", color);
    }
    function applyTheme(theme){
      const t = (theme === THEME_AMOLED) ? THEME_AMOLED : THEME_LIGHT;
      activeTheme = t;
      if(t === THEME_AMOLED){
        document.documentElement.setAttribute("data-theme", THEME_AMOLED);
        document.documentElement.style.colorScheme = "dark";
        setMetaThemeColor(META_THEME_AMOLED);
      }else{
        document.documentElement.removeAttribute("data-theme");
        document.documentElement.style.colorScheme = "light";
        setMetaThemeColor(META_THEME_LIGHT);
      }
    }
    function getSystemTheme(){
      try{
        return (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) ? THEME_AMOLED : THEME_LIGHT;
      }catch(_){
        return THEME_LIGHT;
      }
    }
    function initTheme(){
      let pref = null;
      try{ pref = localStorage.getItem(LS_THEME_KEY); }catch(_){ /* ignore */ }
      if(pref !== THEME_AMOLED && pref !== THEME_LIGHT){
        pref = getSystemTheme();
      }
      applyTheme(pref);

      // Follow system only when user has not set a preference.
      try{
        const mql = window.matchMedia ? window.matchMedia("(prefers-color-scheme: dark)") : null;
        if(mql){
          const handler = () => {
            let saved = null;
            try{ saved = localStorage.getItem(LS_THEME_KEY); }catch(_){ /* ignore */ }
            if(saved !== THEME_AMOLED && saved !== THEME_LIGHT){
              applyTheme(getSystemTheme());
              const tgl = document.getElementById("amoledToggle");
              if(tgl) tgl.checked = (activeTheme === THEME_AMOLED);
            }
          };
          if(typeof mql.addEventListener === "function") mql.addEventListener("change", handler);
          else if(typeof mql.addListener === "function") mql.addListener(handler);
        }
      }catch(_){ /* ignore */ }
    }

    initTheme();



    // Background refresh (best-effort; browsers/OS may still throttle in background)
    let allowBgRefresh = false;
    try{ allowBgRefresh = localStorage.getItem(LS_BG_REFRESH_KEY) === "1"; }catch(_){ /* ignore */ }

// Smooth locate lock: prevent auto-refresh re-render from interrupting smooth scroll-to-card.
// (Manual refresh buttons still work; only the interval auto-refresh is gated.)
let locateLockUntil = 0;
function lockAutoRefreshFor(ms){
  const until = Date.now() + Number(ms || 0);
  if(until > locateLockUntil) locateLockUntil = until;
}
function isAutoRefreshLocked(){
  return Date.now() < locateLockUntil;
}


    /** @type {{id:string, symbol:string, price:number, prevClose:number, open:number, high:number, low:number, avgPrice:number, volRatio:number, status:string, updatedAt:string, stop:number, support:number, breakout:(number|null), tp1:number, tp2:(number|null), name?:string, marketCode?:string}[]} */
    let items = load() ?? [];

    items = migrateItems(items);

    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed)) return null;
        return parsed;
      }catch(_){
        return null;
      }
    }


    function migrateItems(arr){
      if(!Array.isArray(arr)) return [];
      return arr.map((x) => {
        const it = (x && typeof x === "object") ? x : {};
        // Field breakout: optional. Keep finite number; otherwise null.
        const support = Number(it.support);
        const breakoutRaw = String(it.breakout ?? "").replaceAll(",","").trim();
        const breakoutNum = breakoutRaw ? Number(breakoutRaw) : NaN;
        const breakout = Number.isFinite(breakoutNum) ? breakoutNum : null;
        const tp2 = (it.tp2 === null || it.tp2 === undefined || it.tp2 === "") ? null : Number(it.tp2);
        return {
          ...it,
          stop: Number(it.stop),
          support: support,
          breakout: breakout,
          tp1: Number(it.tp1),
          tp2: (Number.isFinite(tp2) ? tp2 : null),
          prevClose: Number.isFinite(Number(it.prevClose)) ? Number(it.prevClose) : NaN,
          open: Number.isFinite(Number(it.open)) ? Number(it.open) : NaN,
          high: Number.isFinite(Number(it.high)) ? Number(it.high) : NaN,
          low: Number.isFinite(Number(it.low)) ? Number(it.low) : NaN,
          avgPrice: Number.isFinite(Number(it.avgPrice)) ? Number(it.avgPrice) : NaN,
          volRatio: Number.isFinite(Number(it.volRatio)) ? Number(it.volRatio) : NaN,
        };
      });
    }

    function persist(){
      localStorage.setItem(LS_KEY, JSON.stringify(items));
    }

    function loadDraft(){
      try{
        const raw = localStorage.getItem(LS_DRAFT_KEY);
        if(!raw) return {};
        const d = JSON.parse(raw);
        return (d && typeof d === "object") ? d : {};
      }catch(_){
        return {};
      }
    }
    function saveDraft(d){
      try{ localStorage.setItem(LS_DRAFT_KEY, JSON.stringify(d)); }catch(_){}
    }

    function nowTime(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${hh}:${mm}:${ss}`;
    }

    function todayYMD(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${dd}`;
    }

    function minutesOfDay(d = new Date()){
      return d.getHours() * 60 + d.getMinutes();
    }

    // A-share call auction windows (local device time):
    // 09:15-09:30 (includes cooling period), 14:57-15:00 (closing auction)
    function isCallAuctionNow(d = new Date()){
      const m = minutesOfDay(d);
      const morning = (m >= 9*60 + 15) && (m < 9*60 + 30);
      const close = (m >= 14*60 + 57) && (m <= 15*60);
      return morning || close;
    }

    function checkNewDayResetPrompt(){
      // Avoid showing blocking dialogs when in background.
      if(document.visibilityState !== "visible") return;

      const today = todayYMD();
      let last = "";
      try{ last = localStorage.getItem(LS_DAY_KEY) || ""; }catch(_){ /* ignore */ }
      if(last === today) return;

      // Mark as seen today so it only prompts once per day.
      try{ localStorage.setItem(LS_DAY_KEY, today); }catch(_){ /* ignore */ }

      if(items.length === 0) return;
      const ok = window.confirm(
        `新交易日提醒：今天是 ${today}。\n是否重置所有股票状态为“监控中”，并清空今日阈值弹窗确认记录？`
      );
      if(ok) resetDailyState();
    }

    function resetDailyState(){
      for(const it of items){
        if(it && typeof it === "object") it.status = "监控中";
      }

      // Clear breakout duration stats for the new trading day
      try{ localStorage.removeItem(LS_BREAKOUT_TS); }catch(_){ /* ignore */ }
      breakoutTS = null;

      alertAck = {};
      saveAlertAck();
      persist();
      updateValuesOnly();
      toast("已重置：状态 & 今日提醒记录");
    }


    function formatCNY(n){
      const x = Number(n);
      if(Number.isNaN(x)) return "¥0.00";
      return "¥" + x.toFixed(2);
    }

    function formatMaybeCNY(n){
      const x = Number(n);
      if(!Number.isFinite(x)) return "--";
      return "¥" + x.toFixed(2);
    }
    function formatRatio(x){
      const n = Number(x);
      if(!Number.isFinite(n)) return "--";
      return (Math.round(n*100)/100).toFixed(2);
    }

    function formatDeltaPct(cur, level){
      const c = Number(cur);
      const l = Number(level);
      if(!Number.isFinite(c) || c === 0 || !Number.isFinite(l)) return "--";
      const pct = (l - c) / c * 100;
      const sign = pct > 0 ? "+" : "";
      return `${sign}${pct.toFixed(2)}%`;
    }

    // ---------- Quote API (Pure Frontend via script injection) ----------
    function toTencentMarketCode(symbol){
      const s = String(symbol).trim();
      if(!/^\d{6}$/.test(s)) throw new Error("symbol must be 6 digits");
      // 6xxxxx -> sh, 0/3xxxxx -> sz, 8/4xxxxx -> bj
      if (s.startsWith("6")) return "sh" + s;
      if (s.startsWith("0") || s.startsWith("3")) return "sz" + s;
      if (s.startsWith("8") || s.startsWith("4")) return "bj" + s;
      return "sz" + s;
    }

    function injectScript(url, timeoutMs = 8000){
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = url;
        s.charset = "gbk";
        s.async = true;

        let done = false;
        const cleanup = () => { try{ s.remove(); }catch(_){ /* ignore */ } };
        const timer = setTimeout(() => {
          if(done) return;
          done = true;
          cleanup();
          reject(new Error("script load timeout"));
        }, timeoutMs);

        s.onload = () => {
          if(done) return;
          done = true;
          clearTimeout(timer);
          cleanup();
          resolve();
        };
        s.onerror = () => {
          if(done) return;
          done = true;
          clearTimeout(timer);
          cleanup();
          reject(new Error("script load failed"));
        };
        document.head.appendChild(s);
      });
    }

    function parseTencentVar(marketCode){
      const key = "v_" + marketCode;
      const raw = window[key];
      if(!raw || typeof raw !== "string") throw new Error(`missing ${key}`);

      const s = raw.replace(/^"+|"+$/g, "");
      const parts = s.split("~");

      const name = parts[1] || "";
      const code6 = parts[2] || marketCode.slice(2);

      // price usually at index 3
      let indicative = false;
      const prevCloseRaw = Number(parts[4]);

      let price = Number(parts[3]);
      if(!Number.isFinite(price) || price <= 0){
        for(let i=3;i<Math.min(parts.length, 20);i++){
          const x = Number(parts[i]);
          if(Number.isFinite(x) && x > 0) { price = x; break; }
        }
      }
      // Pre-market / suspended: price may be 0.00. Fall back to prevClose for display only.
      if((!Number.isFinite(price) || price <= 0) && Number.isFinite(prevCloseRaw) && prevCloseRaw > 0){
        price = prevCloseRaw;
        indicative = true;
      }
      if(!Number.isFinite(price) || price <= 0) throw new Error(`bad price for ${marketCode}`);

      // best-effort mapping (may vary by instrument)
      let prevClose = prevCloseRaw;
      if(!Number.isFinite(prevClose)) prevClose = NaN;

      let open = Number(parts[5]);
      if(!Number.isFinite(open)) open = NaN;

      let high = Number(parts[33]);
      let low  = Number(parts[34]);
      if(!Number.isFinite(high)) high = NaN;
      if(!Number.isFinite(low))  low  = NaN;

      let volRatio = Number(parts[49]);
      if(!Number.isFinite(volRatio)) volRatio = NaN;

      // avg price: prefer explicit field, else compute from amount/volume (best-effort)
      let avgPrice = Number(parts[51]);
      if(!Number.isFinite(avgPrice) || avgPrice <= 0){
        const volHand = Number(parts[36]);
        const amtWan  = Number(parts[37]);
        if(Number.isFinite(volHand) && volHand > 0 && Number.isFinite(amtWan)){
          avgPrice = (amtWan * 100) / volHand; // yuan/share
        }else{
          avgPrice = NaN;
        }
      }

      // datetime: find 14-digit token (YYYYMMDDhhmmss)
      let timeStr = "";
      for(const t of parts){
        if(/^\d{14}$/.test(t) && t.startsWith("20")){
          const hh = t.slice(8,10);
          const mm = t.slice(10,12);
          const ss = t.slice(12,14);
          timeStr = `${hh}:${mm}:${ss}`;
          break;
        }
      }
      if(!timeStr) timeStr = nowTime();

      return { marketCode, code6, name, price, prevClose, open, high, low, avgPrice, volRatio, time: timeStr, indicative };
    }

    async function fetchTencentBatch(marketCodes){
      const uniq = Array.from(new Set(marketCodes.filter(Boolean)));
      if(uniq.length === 0) return [];

      const url = `https://qt.gtimg.cn/q=${encodeURIComponent(uniq.join(","))}&_=${Date.now()}`;
      await injectScript(url);

      const out = [];
      for(const mc of uniq){
        try{
          out.push(parseTencentVar(mc));
        }catch(e){
          out.push({ marketCode: mc, error: String(e.message || e) });
        }
      }
      return out;
    }

    // ---------- UI Rendering ----------
    const listEl = document.getElementById("list");
    const dashEl = document.getElementById("dashboard");
    const dashSummaryEl = document.getElementById("dashSummary");
    const dashBodyEl = document.getElementById("dashBody");
    const dashToggleEl = document.getElementById("dashToggle");
    const dashToggleTextEl = document.getElementById("dashToggleText");
    const cardsToggleEl = document.getElementById("cardsToggle");
    const cardsToggleTextEl = document.getElementById("cardsToggleText");
    const LS_DASH_COLLAPSED = "stock-cards-dash-collapsed-v1";
    const LS_CARD_COLLAPSED = "stock-cards-card-collapsed-v1";
    let cardCollapsedMap = null; // { [id]: 1 }

    function loadCardCollapsed(){
      if(cardCollapsedMap) return cardCollapsedMap;
      try{
        cardCollapsedMap = JSON.parse(localStorage.getItem(LS_CARD_COLLAPSED) || "{}") || {};
      }catch(_){
        cardCollapsedMap = {};
      }
      return cardCollapsedMap;
    }
    function saveCardCollapsed(){
      try{ localStorage.setItem(LS_CARD_COLLAPSED, JSON.stringify(cardCollapsedMap || {})); }catch(_){}
    }
    function isCardCollapsed(id){
      if(!id) return false;
      const m = loadCardCollapsed();
      return !!m[id];
    }
    function setCardCollapsed(id, v){
      if(!id) return;
      const m = loadCardCollapsed();
      if(v) m[id] = 1;
      else delete m[id];
      saveCardCollapsed();
    }

    function updateCardsToggleUi(){
      if(!cardsToggleEl || !cardsToggleTextEl) return;
      const any = Array.isArray(items) && items.length > 0;
      cardsToggleEl.disabled = !any;

      if(!any){
        cardsToggleTextEl.textContent = "全部折叠";
        cardsToggleEl.classList.remove("collapsed");
        cardsToggleEl.title = "全部折叠";
        cardsToggleEl.setAttribute("aria-label", "全部折叠");
        return;
      }

      const allCollapsed = items.every(it => isCardCollapsed(it.id));
      const label = allCollapsed ? "全部展开" : "全部折叠";
      cardsToggleTextEl.textContent = label;
      cardsToggleEl.title = label;
      cardsToggleEl.setAttribute("aria-label", label);
      cardsToggleEl.classList.toggle("collapsed", allCollapsed);
    }

    function setAllCardsCollapsed(v){
      if(!Array.isArray(items)) return;
      for(const it of items){
        setCardCollapsed(it.id, !!v);
      }
      // Update DOM (avoid full re-render)
      document.querySelectorAll(".card").forEach(card => {
        card.classList.toggle("collapsed", !!v);
      });
      // Sync per-card button labels
      document.querySelectorAll('button.tool.collapse[data-id]').forEach(btn => {
        const id = btn.dataset.id;
        const c = isCardCollapsed(id);
        const label = c ? "展开" : "折叠";
        btn.title = label;
        btn.setAttribute("aria-label", label);
      });
      updateCardsToggleUi();
    }

    function initCardsHeader(){
      if(!cardsToggleEl) return;
      updateCardsToggleUi();
      cardsToggleEl.addEventListener("click", () => {
        if(!Array.isArray(items) || items.length === 0) return;
        const anyExpanded = items.some(it => !isCardCollapsed(it.id));
        setAllCardsCollapsed(anyExpanded);
      });
    }


    const LS_BREAKOUT_TS = "stock-cards-breakout-ts-v1";
    let breakoutTS = null; // { [symbol]: { ts:number, day:string } }

    function loadBreakoutTS(){
      if(breakoutTS) return breakoutTS;
      try{
        breakoutTS = JSON.parse(localStorage.getItem(LS_BREAKOUT_TS) || "{}") || {};
      }catch(_){
        breakoutTS = {};
      }
      return breakoutTS;
    }
    function saveBreakoutTS(){
      try{ localStorage.setItem(LS_BREAKOUT_TS, JSON.stringify(breakoutTS || {})); }catch(_){}
    }
    function pruneBreakoutTS(){
      const today = todayYMD();
      const m = loadBreakoutTS();
      let changed = false;
      for(const k of Object.keys(m)){
        const o = m[k];
        if(!o || o.day !== today || !Number.isFinite(Number(o.ts))){
          delete m[k];
          changed = true;
        }
      }
      if(changed) saveBreakoutTS();
      return m;
    }
    function ensureBreakoutStart(symbol){
      if(!symbol) return;
      const today = todayYMD();
      const m = loadBreakoutTS();
      const o = m[symbol];
      if(!o || o.day !== today || !Number.isFinite(Number(o.ts))){
        m[symbol] = { ts: Date.now(), day: today };
        saveBreakoutTS();
      }
    }
    function clearBreakoutStart(symbol){
      if(!symbol) return;
      const m = loadBreakoutTS();
      if(Object.prototype.hasOwnProperty.call(m, symbol)){
        delete m[symbol];
        saveBreakoutTS();
      }
    }

    function overlapMs(a0, a1, b0, b1){
      const s = Math.max(a0, b0);
      const e = Math.min(a1, b1);
      return Math.max(0, e - s);
    }
    // Breakout duration: exclude the noon break (11:30-13:00, local time)
    function tradingElapsedMs(startMs, endMs){
  if(!Number.isFinite(Number(startMs)) || !Number.isFinite(Number(endMs))) return NaN;
  const s0 = Number(startMs), e0 = Number(endMs);
  if(e0 < s0) return 0;

  // Sum only in-trading-session overlap:
  // 09:30-11:30 and 13:00-15:00 (exclude lunch break + exclude after 15:00).
  let total = 0;
  let d = new Date(s0);
  while(true){
    const y = d.getFullYear(), mo = d.getMonth(), da = d.getDate();
    const dayStart = new Date(y, mo, da, 0, 0, 0, 0).getTime();
    const dayEnd   = new Date(y, mo, da + 1, 0, 0, 0, 0).getTime();

    const segStart = Math.max(s0, dayStart);
    const segEnd   = Math.min(e0, dayEnd);

    if(segEnd > segStart){
      const s1Start = new Date(y, mo, da, 9, 30, 0, 0).getTime();
      const s1End   = new Date(y, mo, da, 11, 30, 0, 0).getTime();
      const s2Start = new Date(y, mo, da, 13, 0, 0, 0).getTime();
      const s2End   = new Date(y, mo, da, 15, 0, 0, 0).getTime();
      total += overlapMs(segStart, segEnd, s1Start, s1End);
      total += overlapMs(segStart, segEnd, s2Start, s2End);
    }

    if(dayEnd >= e0) break;
    d = new Date(dayEnd);
  }
  return Math.max(0, total);
}

    function getBreakoutDurationMs(symbol){
      pruneBreakoutTS();
      const m = loadBreakoutTS();
      const o = m[symbol];
      if(o && Number.isFinite(Number(o.ts))){
        return tradingElapsedMs(Number(o.ts), Date.now());
      }
      return NaN;
    }
    function formatDurationCN(ms){
      if(!Number.isFinite(ms) || ms < 0) return "--";
      const s = Math.floor(ms / 1000);
      const m = Math.floor(s / 60);
      const h = Math.floor(m / 60);
      const d = Math.floor(h / 24);
      if(d > 0) return `${d}天${h % 24}时`;
      if(h > 0) return `${h}时${m % 60}分`;
      return `${m}分`;
    }


    // Strong board rank memory (for up/down arrows)
    let strongRankPrev = {};


    function getDashCollapsed(){
      try{ return localStorage.getItem(LS_DASH_COLLAPSED) === "1"; }catch(_){ return false; }
    }
    function setDashCollapsed(v){
      if(!dashEl) return;
      dashEl.classList.toggle("collapsed", !!v);
      if(dashToggleTextEl) dashToggleTextEl.textContent = v ? "展开" : "收起";
      try{ localStorage.setItem(LS_DASH_COLLAPSED, v ? "1" : "0"); }catch(_){}
    }
    function initDashboard(){
      if(!dashEl || !dashToggleEl) return;
      setDashCollapsed(getDashCollapsed());
      dashToggleEl.addEventListener("click", () => {
        setDashCollapsed(!dashEl.classList.contains("collapsed"));
      });

      // Click row to locate its stock card
      if(dashBodyEl){
        dashBodyEl.addEventListener("click", (e) => {
          const tr = e.target && e.target.closest ? e.target.closest("tr[data-symbol]") : null;
          if(!tr) return;
          const sym = tr.getAttribute("data-symbol") || "";
          const id = "card-" + sym;

          // Prevent interval auto-refresh from re-rendering mid-scroll and stopping early.
          lockAutoRefreshFor(2500);

          const el = document.getElementById(id);
          if(!el) return;

          // Prefer scrollIntoView to respect nested scroll containers (more robust on mobile).
          try{
            el.scrollIntoView({ behavior: "smooth", block: "start" });
          }catch(_){
            try{ el.scrollIntoView(); }catch(__){}
          }

          // Second/third pass after layout settles (e.g., CSS reflow or dashboard resize).
          setTimeout(() => {
            const el2 = document.getElementById(id);
            if(!el2) return;
            try{ el2.scrollIntoView({ behavior: "smooth", block: "start" }); }catch(_){ try{ el2.scrollIntoView(); }catch(__){} }
          }, 450);

          setTimeout(() => {
            const el3 = document.getElementById(id);
            if(!el3) return;
            try{ el3.scrollIntoView({ behavior: "auto", block: "start" }); }catch(_){ try{ el3.scrollIntoView(); }catch(__){} }
          }, 900);
        });
      }

    }

    function stockTitle(it){
      const n = (it && it.name) ? String(it.name) : "";
      const s = (it && it.symbol) ? String(it.symbol) : "";
      if(n && s) return `${n} ${s}`;
      return n || s || "--";
    }


    // Dashboard cell: align stock name + code (left aligned, fixed columns).
    function dashStockCell(it, arrowHtml){
      const n = (it && it.name) ? String(it.name) : "";
      const s = (it && it.symbol) ? String(it.symbol) : "";

      // If the caller provided the 2nd argument, we keep the arrow column.
      // Triggered list calls dashStockCell(it) with 1 arg, so it gets the noarrow layout.
      const keepArrowCol = (arguments.length >= 2);
      const cls = keepArrowCol ? "dash-stock" : "dash-stock noarrow";

      const arrow = keepArrowCol
        ? (arrowHtml || '<span class="rank-arrow placeholder" aria-hidden="true">▲</span>')
        : "";

      if(n && s){
        return `<span class="${cls}">${arrow}<span class="dash-name">${escapeHtml(n)}</span><span class="dash-code">${escapeHtml(s)}</span></span>`;
      }
      const label = n || s || "--";
      return `<span class="${cls}">${arrow}<span class="dash-name">${escapeHtml(label)}</span><span class="dash-code"></span></span>`;
    }

    function renderDashboard(){
      pruneBreakoutTS();
      if(!dashEl) return;
      if(!Array.isArray(items) || items.length === 0){
        dashEl.hidden = true;
        return;
      }

      const stopped = items.filter(it => it && String(it.status||"").trim() === "已止损");
      const broken  = items.filter(it => it && String(it.status||"").trim() === "已突破");
      const aboveAvg = items
        .filter(it => it && Number.isFinite(Number(it.price)) && Number.isFinite(Number(it.avgPrice)) && Number(it.avgPrice) > 0 && Number(it.price) > Number(it.avgPrice))
        .map(it => {
          const cur = Number(it.price);
          const avg = Number(it.avgPrice);
          const gapPct = avg > 0 ? (cur - avg) / avg * 100 : NaN;
          return { it, cur, avg, gapPct };
        })
        .sort((a,b) => (b.gapPct || -Infinity) - (a.gapPct || -Infinity));

      const stopCount = stopped.length;
      const breakCount = broken.length;
      const aboveCount = aboveAvg.length;
      const totalCount = items.length;
      if(dashSummaryEl) dashSummaryEl.textContent = `总数 ${totalCount} · 止损 ${stopCount} · 突破 ${breakCount} · 强势 ${aboveCount}`;

      let html = "";

      // A) Triggered: stop-loss + breakout
      html += `<div class="dash-section">
        <table class="dash-table" aria-label="触发列表">
          <thead>
            <tr>
              <th style="width:30%;">状态</th>
              <th style="width:34%;">股票</th>
              <th class="num" style="width:18%;">现价</th>
              <th class="num" style="width:18%;">触发位</th>
            </tr>
          </thead>
          <tbody>`;

      const triggered = [
        ...stopped.map(it => ({ it, kind:"stop" })),
        ...broken.map(it => ({ it, kind:"break" })),
      ];

      if(triggered.length === 0){
        html += `</tbody></table><div class="dash-empty">暂无触发（止损 / 突破）</div></div>`;
      }else{
        for(const row of triggered){
          const it = row.it;
          const kind = row.kind;
          let tags = "";
          if(kind === "stop"){
            tags = `<span class="d-tag d-stop">已止损</span>`;
          }else{
            const durMs = getBreakoutDurationMs(it.symbol);
            const dur = Number.isFinite(durMs) ? formatDurationCN(durMs) : "--";
            const durPill = (dur && dur !== "--") ? `<span class="d-tag d-dur">${escapeHtml(dur)}</span>` : "";
            tags = `<span class="d-tags"><span class="d-tag d-break">已突破</span>${durPill}</span>`;
          }
          const level = kind === "stop" ? Number(it.stop) : Number(it.breakout);
          const levelTxt = Number.isFinite(level) ? formatCNY(level) : "--";
          html += `<tr class="dash-row" data-symbol="${escapeHtml(it.symbol)}">
            <td>${tags}</td>
            <td class="stock" title="${escapeHtml(stockTitle(it))}">${dashStockCell(it)}</td>
            <td class="num">${formatCNY(it.price)}</td>
            <td class="num">${levelTxt}</td>
          </tr>`;
        }
        html += `</tbody></table></div>`;
      }

      // B) Above average price (show breakout instead of stop)
      html += `<div class="dash-section">
        <table class="dash-table dash-strong" aria-label="均价上方列表">
          <thead>
            <tr>
              <th style="width:40%;">股票</th>
              <th class="num" style="width:16%;">现价</th>
              <th class="num" style="width:16%;">均价</th>
              <th class="num" style="width:15%;">突破</th>
              <th class="num" style="width:13%;">距均价</th>
            </tr>
          </thead>
          <tbody>`;

      if(aboveAvg.length === 0){
        html += `</tbody></table><div class="dash-empty">暂无“均价上方”股票</div></div>`;
}else{
  const _prevStrong = strongRankPrev || {};
  const _nextStrong = {};
  let _iStrong = 0;

  for(const x of aboveAvg){
    const it = x.it;
    const sym = String(it.symbol || "");
    const prevIdxRaw = _prevStrong[sym];
    const prevIdx = Number.isFinite(Number(prevIdxRaw)) ? Number(prevIdxRaw) : null;

    let arrowCls = "flat";
    let arrowChar = "&nbsp;";
    if(prevIdx !== null){
      if(_iStrong < prevIdx){ arrowCls = "up"; arrowChar = "▲"; }
      else if(_iStrong > prevIdx){ arrowCls = "down"; arrowChar = "▼"; }
    }
    const arrowHtml = `<span class="rank-arrow ${arrowCls}">${arrowChar}</span>`;

    const gap = x.gapPct;
    const gapTxt = Number.isFinite(gap) ? `${gap > 0 ? "+" : ""}${gap.toFixed(2)}%` : "--";
    const br = Number(it.breakout);
    const brTxt = Number.isFinite(br) ? formatCNY(br) : "--";

    html += `<tr class="dash-row" data-symbol="${escapeHtml(it.symbol)}">
      <td class="stock" title="${escapeHtml(stockTitle(it))}">${dashStockCell(it, arrowHtml)}</td>
      <td class="num">${formatCNY(it.price)}</td>
      <td class="num">${formatCNY(it.avgPrice)}</td>
      <td class="num">${brTxt}</td>
      <td class="num"><span class="d-tag d-avg">${escapeHtml(gapTxt)}</span></td>
    </tr>`;

    _nextStrong[sym] = _iStrong;
    _iStrong += 1;
  }

  strongRankPrev = _nextStrong;
  html += `</tbody></table></div>`;
}
if(dashBodyEl) dashBodyEl.innerHTML = html;
      dashEl.hidden = false;
    }

    initDashboard();
    initCardsHeader();


    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function statusCls(s){
      const x = String(s || "");
      if(x === "已止损") return "red";
      if(x === "已突破") return "blue";
      if(x === "已止盈1" || x === "已止盈2") return "green";
      if(x === "更新失败") return "muted";
      // default: 监控中 / others
      return "amber";
    }

    function render(){
      renderDashboard();
      listEl.innerHTML = "";
      updateCardsToggleUi();
      if(items.length === 0){
        const empty = document.createElement("div");
        empty.style.padding = "14px 4px";
        empty.style.color = "var(--muted)";
        empty.style.fontWeight = "800";
        empty.textContent = "暂无股票。点击“添加”创建第一张策略卡。";
        listEl.appendChild(empty);
        return;
      }

      items.forEach((it) => {
        const hasBreakout = Number.isFinite(it.breakout);
        const hasTp2 = Number.isFinite(it.tp2);
        let colsClass = "cols-4";
        const pillCount = 3 + (hasBreakout ? 1 : 0) + (hasTp2 ? 1 : 0);
        if(pillCount === 3) colsClass = "cols-3";
        else if(pillCount === 5) colsClass = "cols-5";
        const prev = Number(it.prevClose);
        const cur = Number(it.price);
        let priceDirClass = "flat";
        if(Number.isFinite(prev) && Number.isFinite(cur)){
          if(cur > prev) priceDirClass = "up";
          else if(cur < prev) priceDirClass = "down";
        }

        const avg = Number(it.avgPrice);
        let avgDirClass = "";
        if(Number.isFinite(cur) && Number.isFinite(avg) && avg > 0){
          if(cur > avg) avgDirClass = "avg-up";
          else if(cur < avg) avgDirClass = "avg-down";
          else avgDirClass = "avg-flat";
        }

                // pct change badge (does not affect layout height: absolutely positioned)
        let chgPct = NaN;
        if(Number.isFinite(prev) && prev > 0 && Number.isFinite(cur)){
          chgPct = (cur - prev) / prev * 100;
        }
        let chgClass = "flat";
        let chgText = "--";
        let chgDisp = "--";
        if(Number.isFinite(chgPct)){
          if(chgPct > 1e-8) chgClass = "up";
          else if(chgPct < -1e-8) chgClass = "down";
          const sign = chgPct > 0 ? "+" : "";
          chgText = `${sign}${chgPct.toFixed(2)}%`;
          chgDisp = `${chgPct > 0 ? '▲' : (chgPct < 0 ? '▼' : '•')} ${Math.abs(chgPct).toFixed(2)}%`;
        }

        const stopDelta = formatDeltaPct(cur, it.stop);
        const supportDelta = formatDeltaPct(cur, it.support);
        const breakoutDelta = Number.isFinite(it.breakout) ? formatDeltaPct(cur, it.breakout) : "--";
        const tp1Delta = formatDeltaPct(cur, it.tp1);
        const tp2Delta = Number.isFinite(it.tp2) ? formatDeltaPct(cur, it.tp2) : "--";

        const card = document.createElement("div");
        const cardCollapsed = isCardCollapsed(it.id);
        card.className = "card" + (cardCollapsed ? " collapsed" : "");
        card.id = "card-" + it.symbol;

        const bigTitle = it.name ? escapeHtml(it.name) : escapeHtml(it.symbol);
        const sub = it.name ? `${escapeHtml(it.symbol)} · ${escapeHtml(it.name)}` : `${escapeHtml(it.symbol)}`;
        const noteText = String(it.note ?? "").replace(/\s+/g, " ").trim();
        const noteTitle = noteText ? escapeHtml(noteText) : "";
        const noteHtml = noteText ? escapeHtml(noteText) : '<span class="note-ph">备注</span>';
        const collapseLabel = cardCollapsed ? "展开" : "折叠";

        // --- Template A++: Visual Meter (scale: intraday low -> intraday high; levels may extend into invalid zones) ---
const lowNum0 = Number(it.low);
const highNum0 = Number(it.high);
const hasDayRange = Number.isFinite(lowNum0) && Number.isFinite(highNum0) && highNum0 > lowNum0;

// Domain should include intraday low/high and key strategy levels so marks won't be clipped at edges.
const cand = [];
const pushN = (v) => {
  if(v === null || v === undefined) return;
  if(typeof v === "string" && v.trim() === "") return;
  const n = Number(v);
  if(Number.isFinite(n) && n > 0) cand.push(n);
};

pushN(it.low); pushN(it.high);
pushN(it.stop); pushN(it.support); pushN(it.breakout); pushN(it.tp1); pushN(it.tp2);
pushN(it.price); pushN(it.avgPrice); pushN(it.open); pushN(it.prevClose);

let baseMin = cand.length ? Math.min(...cand) : cur;
let baseMax = cand.length ? Math.max(...cand) : cur;

// Ensure a sane range even if inputs are missing/invalid
if(!(Number.isFinite(baseMin) && Number.isFinite(baseMax)) || baseMax <= baseMin){
  baseMin = (Number.isFinite(it.stop) ? Number(it.stop) : cur);
  baseMax = (Number.isFinite(it.tp2) ? Number(it.tp2) : (Number.isFinite(it.tp1) ? Number(it.tp1) : cur));
}

const rangeOk = Number.isFinite(baseMin) && Number.isFinite(baseMax) && baseMax > baseMin;

const padPct = METER_PAD_PCT;
const usablePct = Math.max(1, 100 - padPct * 2);

// Map values to [0..100] with extra span shown in the "invalid" side zones.
// baseMin maps to padPct, baseMax maps to 100-padPct.
const posX = (val) => {
  const v = Number(val);
  if(!rangeOk || !Number.isFinite(v)) return padPct;
  const span = baseMax - baseMin;
  const extraSpan = span * (padPct / usablePct);
  const extMin = baseMin - extraSpan;
  const extMax = baseMax + extraSpan;
  const pct = (v - extMin) / (extMax - extMin) * 100;
  return Math.max(0, Math.min(100, pct));
};

const baseLeft = posX(baseMin);
const curX = posX(cur);
const fillW = Math.max(0, curX - baseLeft);

// Intraday low-high floating band (not clipped by stop/tp; may use invalid zones)
const dayRangeOk = hasDayRange;
const dayL = dayRangeOk ? posX(it.low) : 0;
const dayH = dayRangeOk ? posX(it.high) : 0;
const dayLeft = Math.min(dayL, dayH);
const dayRight = Math.max(dayL, dayH);
const dayWidth = dayRangeOk ? Math.max(1, dayRight - dayLeft) : 0;

// Avg tick (yellow) inside the intraday band
const avgNum = Number(it.avgPrice);
let avgX = (dayRangeOk && Number.isFinite(avgNum)) ? posX(avgNum) : NaN;
if(dayRangeOk && Number.isFinite(avgX)){
  avgX = Math.max(dayLeft, Math.min(dayRight, avgX));
}

const bracketHtml = dayRangeOk ? `
  <div class="range-bracket-layer">
    <div class="range-bracket" style="left:${dayLeft}%; width:${dayWidth}%"></div>
    ${Number.isFinite(avgX) ? `<div class="range-avg-tick" style="left:${avgX}%"></div>` : ""}
  </div>
` : "";

const stopNum = Number(it.stop);
const tp2Num = (it.tp2 === null || it.tp2 === undefined || it.tp2 === "") ? NaN : Number(it.tp2);
const tp1Num = Number(it.tp1);
const supportNum = Number(it.support);
const breakoutNum = Number(it.breakout);
const lowNum = Number(it.low);
const highNum = Number(it.high);

const stopVal = Number.isFinite(stopNum) ? formatCNY(stopNum) : "--";
const targetNum = Number.isFinite(tp2Num) ? tp2Num : (Number.isFinite(tp1Num) ? tp1Num : NaN);
const targetVal = Number.isFinite(targetNum) ? formatCNY(targetNum) : "--";
const targetLabel = Number.isFinite(tp2Num) ? "止盈2" : (Number.isFinite(tp1Num) ? "止盈1" : "目标");

const epsEq = (a,b) => Number.isFinite(a) && Number.isFinite(b) && Math.abs(a-b) <= Math.max(1e-6, Math.abs(b)*1e-8);
const isEdge = (n) => epsEq(n, baseMin) || epsEq(n, baseMax);

const leftIsStop = Number.isFinite(stopNum) && epsEq(stopNum, baseMin);
const leftIsLow  = hasDayRange && Number.isFinite(lowNum) && epsEq(lowNum, baseMin);
const leftIsSupport = Number.isFinite(supportNum) && epsEq(supportNum, baseMin);

const endLeftLabel = leftIsStop ? "止损" : (leftIsLow ? "最低" : (leftIsSupport ? "支撑位" : "下界"));
const endLeftVal   = leftIsStop ? stopVal : (leftIsLow ? formatCNY(lowNum) : (leftIsSupport ? formatCNY(supportNum) : formatCNY(baseMin)));
const endLeftCls   = leftIsStop ? "risk" : "neutral";

const rightIsTarget = Number.isFinite(targetNum) && epsEq(targetNum, baseMax);
const rightIsHigh   = hasDayRange && Number.isFinite(highNum) && epsEq(highNum, baseMax);
const rightIsBreakout = Number.isFinite(breakoutNum) && epsEq(breakoutNum, baseMax);
const rightIsSupport  = Number.isFinite(supportNum) && epsEq(supportNum, baseMax);

const endRightLabel = rightIsTarget ? targetLabel : (rightIsHigh ? "最高" : (rightIsBreakout ? "突破位" : (rightIsSupport ? "支撑位" : "上界")));
const endRightVal   = rightIsTarget ? targetVal : (rightIsHigh ? formatCNY(highNum) : (rightIsBreakout ? formatCNY(breakoutNum) : (rightIsSupport ? formatCNY(supportNum) : formatCNY(baseMax))));
const endRightCls   = rightIsTarget ? "profit" : "neutral";

// Mid markers (support / breakout / tp1) — hide chips if they are already represented by the two end extremes
const meterMarks = [];
if(Number.isFinite(supportNum) && !isEdge(supportNum)) meterMarks.push({ key:"support", cls: "amber", name: "支撑位", value: formatCNY(supportNum), pos: posX(supportNum) });
if(Number.isFinite(breakoutNum) && !isEdge(breakoutNum)) meterMarks.push({ key:"breakout", cls: "blue",  name: "突破位", value: formatCNY(breakoutNum), pos: posX(breakoutNum) });
if(Number.isFinite(tp1Num) && !isEdge(tp1Num))          meterMarks.push({ key:"tp1", cls: "green", name: "止盈1", value: formatCNY(tp1Num), pos: posX(tp1Num) });

meterMarks.sort((a,b)=>a.pos-b.pos);

// --- Collision handling: L/R/T side-split (avoid chip overlap) ---
const GAP_THRESHOLD = 12; // two marks closer than this (%) are considered crowded

// Initialize all marks to Center
meterMarks.forEach(m => m.side = 'C');

for(let i = 0; i < meterMarks.length - 1; i++){
  const curr = meterMarks[i];
  const next = meterMarks[i+1];

  if(next.pos - curr.pos < GAP_THRESHOLD){
    // A) Two crowded marks -> Left + Right
    if(curr.side === 'C'){
      curr.side = 'L';
      next.side = 'R';
    }
    // B) 3-chain collision: Prev(L) - Curr(R) - Next(?) -> keep Curr centered
    else if(curr.side === 'R'){
      // 3-chain: keep the middle mark centered to avoid chip order inversion
      curr.side = 'C';
      next.side = 'R';
    }
  }
}

// Edge guard: keep chips inside; hide only at extreme edges
meterMarks.forEach(m => {
  if(m.pos < 12) m.side = 'R';
  if(m.pos > 88) m.side = 'L';
  m.compact = (m.pos < 1 || m.pos > 99);
});

const meterMarkHtml = meterMarks.map(m => `
  <div class="meter-mark ${m.cls} ${m.compact ? 'compact' : ''}" data-key="${m.key || ''}" data-side="${m.side || 'C'}" style="left:${m.pos}%">
    <div class="mark-line"></div>
    <div class="mark-chip" title="${escapeHtml(m.name)} ${escapeHtml(m.value)}">
      <div class="chip-l">${escapeHtml(m.name)}</div>
      <div class="chip-v">${escapeHtml(m.value)}</div>
    </div>
  </div>
`).join("");

const meterHtml = rangeOk ? `
  <div class="meter-wrap" style="--meter-pad:${padPct};">
    <div class="meter-track">
      <div class="meter-invalid left"></div>
      <div class="meter-invalid right"></div>
      <div class="meter-fill ${priceDirClass}" style="left:${baseLeft}%; width:${fillW}%"></div>
    </div>

    ${bracketHtml}

    ${meterMarkHtml}

    <div class="meter-end left" data-key="min">
      <div class="end-line"></div>
      <div class="end-label">${escapeHtml(endLeftLabel)}</div>
      <div class="end-val ${escapeHtml(endLeftCls)}">${escapeHtml(endLeftVal)}</div>
    </div>

    <div class="meter-end right" data-key="max">
      <div class="end-line"></div>
      <div class="end-label">${escapeHtml(endRightLabel)}</div>
      <div class="end-val ${escapeHtml(endRightCls)}">${escapeHtml(endRightVal)}</div>
    </div>

    <div class="meter-cursor ${priceDirClass}" style="left:${curX}%">
      <div class="tri"></div>
      <div class="dot"></div>
    </div>
  </div>
` : "";
card.innerHTML = `
          <div class="card-inner">
            <div class="card-top">
              <div class="codes">
                <div class="title-row">
                  <p class="big">${bigTitle}</p>
                  <span class="code">${escapeHtml(it.symbol)}</span>
                </div>
              </div>
              <div class="card-tools">
                <button class="tool sort-only" data-act="moveUp" data-id="${it.id}" aria-label="Move Up" title="上移">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 19V5"></path>
                    <path d="M6 11l6-6 6 6"></path>
                  </svg>
                </button>
                <button class="tool sort-only" data-act="moveDown" data-id="${it.id}" aria-label="Move Down" title="下移">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 5v14"></path>
                    <path d="M18 13l-6 6-6-6"></path>
                  </svg>
                </button>
                <button class="tool collapse" data-act="collapse" data-id="${it.id}" aria-label="${collapseLabel}" title="${collapseLabel}">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 9l6 6 6-6"></path>
                  </svg>
                </button>
                <button class="tool" data-act="edit" data-id="${it.id}" aria-label="Edit" title="编辑">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
                  </svg>
                </button>
                <button class="tool danger" data-act="del" data-id="${it.id}" aria-label="Delete" title="删除">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18"></path>
                    <path d="M8 6V4h8v2"></path>
                    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                    <path d="M10 11v6"></path>
                    <path d="M14 11v6"></path>
                  </svg>
                </button>
              </div>
            </div>

            <div class="card-bd">
            <div class="note-row">
              <div class="card-note" aria-expanded="false" title="${noteTitle}">${noteHtml}</div>
            </div>

            <div class="core-row">
              <div class="core-left">
                <div class="label">当前价格</div>
                <div class="core-line">
                  <span class="core-price ${priceDirClass}">${formatCNY(it.price)}</span>
                  <span class="core-change ${chgClass}">${escapeHtml(chgDisp)}</span>
                </div>
                
              </div>

              <div class="core-right">
                <div class="updated-row">
                  <span>Updated ${escapeHtml(it.updatedAt)}</span>
                  <button class="refresh-mini" data-act="refresh" data-id="${it.id}" aria-label="Refresh" title="更新">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21 12a9 9 0 0 1-15.3 6.4"></path>
                      <path d="M3 12a9 9 0 0 1 15.3-6.4"></path>
                      <path d="M3 3v6h6"></path>
                      <path d="M21 21v-6h-6"></path>
                    </svg>
                  </button>
                </div>

                <div class="status-pill ${statusCls(it.status)}"><span class="pulse-dot"></span>${escapeHtml(it.status)}</div>
              </div>
            </div>

            ${meterHtml}

            <div class="stats-grid">
              <div class="dp"><div class="dp-l">今开</div><div class="dp-v">${formatMaybeCNY(it.open)}</div></div>
              <div class="dp"><div class="dp-l">最高</div><div class="dp-v">${formatMaybeCNY(it.high)}</div></div>
              <div class="dp"><div class="dp-l">均价</div><div class="dp-v">${formatMaybeCNY(it.avgPrice)}</div></div>
              <div class="dp"><div class="dp-l">昨收</div><div class="dp-v">${formatMaybeCNY(it.prevClose)}</div></div>
              <div class="dp"><div class="dp-l">最低</div><div class="dp-v">${formatMaybeCNY(it.low)}</div></div>
              <div class="dp"><div class="dp-l">量比</div><div class="dp-v">${formatRatio(it.volRatio)}</div></div>
            </div>

            </div>

          </div>
        `;

        listEl.appendChild(card);
      });
    }

    // ---------- Incremental UI update (avoid full list re-render on price refresh) ----------
    function computePriceDirClass(prev, cur){
      let cls = "flat";
      if(Number.isFinite(prev) && Number.isFinite(cur)){
        if(cur > prev) cls = "up";
        else if(cur < prev) cls = "down";
      }
      return cls;
    }

    function computeChangeDisplay(prev, cur){
      let chgDisp = "--";
      let chgClass = "flat";
      if(Number.isFinite(prev) && prev > 0 && Number.isFinite(cur)){
        const chgPct = (cur - prev) / prev * 100;
        if(chgPct > 1e-8) chgClass = "up";
        else if(chgPct < -1e-8) chgClass = "down";
        chgDisp = `${chgPct > 0 ? '▲' : (chgPct < 0 ? '▼' : '•')} ${Math.abs(chgPct).toFixed(2)}%`;
      }
      return { chgDisp, chgClass };
    }

    function updateStatsGrid(card, it){
      const dps = card.querySelectorAll(".stats-grid .dp");
      if(!dps || dps.length === 0) return;
      dps.forEach((dp) => {
        const k = (dp.querySelector(".dp-l")?.textContent || "").trim();
        const v = dp.querySelector(".dp-v");
        if(!v) return;
        if(k === "今开") v.textContent = formatMaybeCNY(it.open);
        else if(k === "昨收") v.textContent = formatMaybeCNY(it.prevClose);
        else if(k === "最高") v.textContent = formatMaybeCNY(it.high);
        else if(k === "最低") v.textContent = formatMaybeCNY(it.low);
        else if(k === "均价") v.textContent = formatMaybeCNY(it.avgPrice);
        else if(k === "量比") v.textContent = formatRatio(it.volRatio);
      });
    }

    function updateMeter(card, it, priceDirClass){
      const meterWrap = card.querySelector(".meter-wrap");
      if(!meterWrap) return true;

      // keep CSS var in sync (render sets it too)
      meterWrap.style.setProperty("--meter-pad", String(METER_PAD_PCT));

      const cur = Number(it.price);

      const lowNum0 = Number(it.low);
      const highNum0 = Number(it.high);
      const hasDayRange = Number.isFinite(lowNum0) && Number.isFinite(highNum0) && highNum0 > lowNum0;

      // Domain should include intraday low/high and key strategy levels so marks won't be clipped at edges.
      const cand = [];
      const pushN = (v) => {
        if(v === null || v === undefined) return;
        if(typeof v === "string" && v.trim() === "") return;
        const n = Number(v);
        if(Number.isFinite(n) && n > 0) cand.push(n);
      };

      pushN(it.low); pushN(it.high);
      pushN(it.stop); pushN(it.support); pushN(it.breakout); pushN(it.tp1); pushN(it.tp2);
      pushN(it.price); pushN(it.avgPrice); pushN(it.open); pushN(it.prevClose);

      let baseMin = cand.length ? Math.min(...cand) : cur;
      let baseMax = cand.length ? Math.max(...cand) : cur;

      // Ensure a sane range even if inputs are missing/invalid
      if(!(Number.isFinite(baseMin) && Number.isFinite(baseMax)) || baseMax <= baseMin){
        baseMin = (Number.isFinite(it.stop) ? Number(it.stop) : cur);
        baseMax = (Number.isFinite(it.tp2) ? Number(it.tp2) : (Number.isFinite(it.tp1) ? Number(it.tp1) : cur));
      }

      const rangeOk = Number.isFinite(baseMin) && Number.isFinite(baseMax) && baseMax > baseMin;
      if(!rangeOk) return false;

      const padPct = METER_PAD_PCT;
      const usablePct = Math.max(1, 100 - padPct * 2);

      const posX = (val) => {
        const v = Number(val);
        if(!Number.isFinite(v)) return padPct;
        const span = baseMax - baseMin;
        const extraSpan = span * (padPct / usablePct);
        const extMin = baseMin - extraSpan;
        const extMax = baseMax + extraSpan;
        const pct = (v - extMin) / (extMax - extMin) * 100;
        return Math.max(0, Math.min(100, pct));
      };

      const baseLeft = posX(baseMin);
      const curX = posX(cur);
      const fillW = Math.max(0, curX - baseLeft);

      const meterTrack = meterWrap.querySelector(".meter-track");
      if(meterTrack){
        // Ensure invalid overlays exist (in case of older cards)
        if(!meterTrack.querySelector(".meter-invalid.left")){
          meterTrack.insertAdjacentHTML("afterbegin", '<div class="meter-invalid left"></div><div class="meter-invalid right"></div>');
        }
      }

      const fill = meterWrap.querySelector(".meter-fill");
      if(fill){
        fill.className = `meter-fill ${priceDirClass}`;
        fill.style.left = `${baseLeft}%`;
        fill.style.width = `${fillW}%`;
      }
      const cursor = meterWrap.querySelector(".meter-cursor");
      if(cursor){
        cursor.className = `meter-cursor ${priceDirClass}`;
        cursor.style.left = `${curX}%`;
      }

      // End labels: choose extremes from (intraday low/high) AND (stop/targets) so key levels remain visible
      const stopNum = Number(it.stop);
      const tp2Num = (it.tp2 === null || it.tp2 === undefined || it.tp2 === "") ? NaN : Number(it.tp2);
      const tp1Num = Number(it.tp1);
      const lowNum = Number(it.low);
      const highNum = Number(it.high);

      const stopVal = Number.isFinite(stopNum) ? formatCNY(stopNum) : "--";
      const targetNum = Number.isFinite(tp2Num) ? tp2Num : (Number.isFinite(tp1Num) ? tp1Num : NaN);
      const targetVal = Number.isFinite(targetNum) ? formatCNY(targetNum) : "--";
      const targetLabel = Number.isFinite(tp2Num) ? "止盈2" : (Number.isFinite(tp1Num) ? "止盈1" : "目标");

      const epsEq = (a,b) => Number.isFinite(a) && Number.isFinite(b) && Math.abs(a-b) <= Math.max(1e-6, Math.abs(b)*1e-8);
      const isEdge = (n) => epsEq(n, baseMin) || epsEq(n, baseMax);

      const supportNum = Number(it.support);
      const breakoutNum = Number(it.breakout);

      const leftIsStop = Number.isFinite(stopNum) && epsEq(stopNum, baseMin);
      const leftIsLow  = hasDayRange && Number.isFinite(lowNum) && epsEq(lowNum, baseMin);
      const leftIsSupport = Number.isFinite(supportNum) && epsEq(supportNum, baseMin);

      const endLeftLabel = leftIsStop ? "止损" : (leftIsLow ? "最低" : (leftIsSupport ? "支撑位" : "下界"));
      const endLeftVal   = leftIsStop ? stopVal : (leftIsLow ? formatCNY(lowNum) : (leftIsSupport ? formatCNY(supportNum) : formatCNY(baseMin)));
      const endLeftCls   = leftIsStop ? "risk" : "neutral";

      const rightIsTarget = Number.isFinite(targetNum) && epsEq(targetNum, baseMax);
      const rightIsHigh   = hasDayRange && Number.isFinite(highNum) && epsEq(highNum, baseMax);
      const rightIsBreakout = Number.isFinite(breakoutNum) && epsEq(breakoutNum, baseMax);
      const rightIsSupport  = Number.isFinite(supportNum) && epsEq(supportNum, baseMax);

      const endRightLabel = rightIsTarget ? targetLabel : (rightIsHigh ? "最高" : (rightIsBreakout ? "突破位" : (rightIsSupport ? "支撑位" : "上界")));
      const endRightVal   = rightIsTarget ? targetVal : (rightIsHigh ? formatCNY(highNum) : (rightIsBreakout ? formatCNY(breakoutNum) : (rightIsSupport ? formatCNY(supportNum) : formatCNY(baseMax))));
      const endRightCls   = rightIsTarget ? "profit" : "neutral";

      const minEnd = meterWrap.querySelector('.meter-end[data-key="min"]');
      if(minEnd){
        const lab = minEnd.querySelector(".end-label");
        const v = minEnd.querySelector(".end-val");
        if(lab) lab.textContent = endLeftLabel;
        if(v){
          v.className = `end-val ${endLeftCls}`;
          v.textContent = endLeftVal;
        }
      }else{
        return false;
      }

      const maxEnd = meterWrap.querySelector('.meter-end[data-key="max"]');
      if(maxEnd){
        const lab = maxEnd.querySelector(".end-label");
        const v = maxEnd.querySelector(".end-val");
        if(lab) lab.textContent = endRightLabel;
        if(v){
          v.className = `end-val ${endRightCls}`;
          v.textContent = endRightVal;
        }
      }else{
        return false;
      }

      // Intraday low-high floating band + avg tick (yellow)
      const dayRangeOk = hasDayRange;
      const dayL = dayRangeOk ? posX(it.low) : 0;
      const dayH = dayRangeOk ? posX(it.high) : 0;
      const dayLeft = Math.min(dayL, dayH);
      const dayRight = Math.max(dayL, dayH);
      const dayWidth = dayRangeOk ? Math.max(1, dayRight - dayLeft) : 0;

      const avgNum = Number(it.avgPrice);
      let avgX = (dayRangeOk && Number.isFinite(avgNum)) ? posX(avgNum) : NaN;
      if(dayRangeOk && Number.isFinite(avgX)){
        avgX = Math.max(dayLeft, Math.min(dayRight, avgX));
      }

      let layer = meterWrap.querySelector(".range-bracket-layer");
      if(dayRangeOk){
        if(!layer){
          layer = document.createElement("div");
          layer.className = "range-bracket-layer";
          const br = document.createElement("div");
          br.className = "range-bracket";
          layer.appendChild(br);
          const tick = document.createElement("div");
          tick.className = "range-avg-tick";
          layer.appendChild(tick);
          const track = meterWrap.querySelector(".meter-track");
          if(track) track.insertAdjacentElement("afterend", layer);
          else meterWrap.insertAdjacentElement("afterbegin", layer);
        }
        const br = layer.querySelector(".range-bracket");
        if(br){
          br.style.left = `${dayLeft}%`;
          br.style.width = `${dayWidth}%`;
        }
        const tick = layer.querySelector(".range-avg-tick");
        if(tick){
          if(Number.isFinite(avgX)){
            tick.style.display = "block";
            tick.style.left = `${avgX}%`;
          }else{
            tick.style.display = "none";
          }
        }
      }else if(layer){
        layer.remove();
      }

      // Strategy marks (support / breakout / tp1) — hide chips if they are already represented by the two end extremes
      const upsertMark = (key, cls, name, rawNum) => {
        const el = meterWrap.querySelector(`.meter-mark[data-key="${key}"]`);
        const show = Number.isFinite(rawNum) && !isEdge(rawNum);

        if(!show){
          if(el) el.remove();
          return true;
        }

        const p = posX(rawNum);
        const value = formatCNY(rawNum);

        if(!el){
          const div = document.createElement("div");
          div.className = `meter-mark ${cls}`;
          div.dataset.key = key;
          div.dataset.side = "C";
          div.style.left = `${p}%`;
          div.innerHTML = `
            <div class="mark-line"></div>
            <div class="mark-chip" title="${escapeHtml(name)} ${escapeHtml(value)}">
              <div class="chip-l">${escapeHtml(name)}</div>
              <div class="chip-v">${escapeHtml(value)}</div>
            </div>
          `;
          const anchor = meterWrap.querySelector('.meter-end[data-key="min"]') || meterWrap.querySelector('.meter-end') || null;
          if(anchor) meterWrap.insertBefore(div, anchor);
          else meterWrap.appendChild(div);
          return true;
        }

        el.className = `meter-mark ${cls}`;
        el.style.left = `${p}%`;
        const l = el.querySelector(".chip-l");
        const v = el.querySelector(".chip-v");
        if(l) l.textContent = name;
        if(v) v.textContent = value;
        return true;
      };

      if(!upsertMark("support", "amber", "支撑位", Number(it.support))) return false;
      if(!upsertMark("breakout", "blue", "突破位", Number(it.breakout))) return false;
      if(!upsertMark("tp1", "green", "止盈1", Number(it.tp1))) return false;

      // Recompute mark side-split after updates (avoid overlap on incremental refresh)
      const markEls = Array.from(meterWrap.querySelectorAll(".meter-mark")).map(el => {
        const pos = Number(String(el.style.left || "").replace("%",""));
        return { el, pos: Number.isFinite(pos) ? pos : 0, side: "C" };
      }).sort((a,b)=>a.pos-b.pos);

      const GAP_THRESHOLD = 12;
      for(let i = 0; i < markEls.length - 1; i++){
        const curr = markEls[i];
        const next = markEls[i+1];
        if(next.pos - curr.pos < GAP_THRESHOLD){
          if(curr.side === "C"){
            curr.side = "L";
            next.side = "R";
          }else if(curr.side === "R"){
            // 3-chain: keep the middle mark centered to avoid chip order inversion
            curr.side = "C";
            next.side = "R";
          }
        }
      }

      markEls.forEach(m => {
        let side = m.side;
        if(m.pos < 12) side = "R";
        if(m.pos > 88) side = "L";
        m.el.dataset.side = side;

        const compact = (m.pos < 1 || m.pos > 99);
        m.el.classList.toggle("compact", compact);
      });

      return true;
    }

    function updateCardValues(it){
      const card = document.getElementById("card-" + it.symbol);
      if(!card) return false;

      const prev = Number(it.prevClose);
      const cur = Number(it.price);
      const priceDirClass = computePriceDirClass(prev, cur);
      const { chgDisp, chgClass } = computeChangeDisplay(prev, cur);

      // Title can change when quote name updates
      const big = card.querySelector(".title-row .big");
      if(big) big.textContent = it.name ? String(it.name) : String(it.symbol);

      const priceEl = card.querySelector(".core-price");
      if(priceEl){
        priceEl.textContent = formatCNY(it.price);
        priceEl.classList.remove("up","down","flat");
        priceEl.classList.add(priceDirClass);
      }

      const chgEl = card.querySelector(".core-change");
      if(chgEl){
        chgEl.textContent = chgDisp;
        chgEl.classList.remove("up","down","flat");
        chgEl.classList.add(chgClass);
      }

      const upd = card.querySelector(".updated-row span");
      if(upd){
        const t = (it.updatedAt ? String(it.updatedAt) : "").trim();
        upd.textContent = t ? `Updated ${t}` : "Updated";
      }

      const pill = card.querySelector(".status-pill");
      if(pill){
        pill.className = `status-pill ${statusCls(it.status)}`;
        pill.innerHTML = `<span class="pulse-dot"></span>${escapeHtml(String(it.status || ""))}`;
      }

      if(!updateMeter(card, it, priceDirClass)) return false;
      updateStatsGrid(card, it);

      return true;
    }

    function updateValuesOnly(){
      // Update dashboard summary (does not touch list DOM)
      renderDashboard();

      let missing = false;
      for(const it of items){
        if(!updateCardValues(it)) missing = true;
      }

      // Safety fallback: if DOM is out of sync (rare), rebuild once.
      if(missing){
        render();
      }
    }


    // ---------- Note expand/collapse ----------
    listEl.addEventListener("click", (e) => {
      const note = e.target.closest(".card-note");
      if(!note) return;
      const expanded = !note.classList.contains("expanded");
      note.classList.toggle("expanded", expanded);
      note.setAttribute("aria-expanded", expanded ? "true" : "false");
    });

    // ---------- Actions ----------
    listEl.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if(!act || !id) return;

      if(act === "collapse"){
        const next = !isCardCollapsed(id);
        setCardCollapsed(id, next);

        const card = btn.closest(".card");
        if(card) card.classList.toggle("collapsed", next);

        const label = next ? "展开" : "折叠";
        btn.title = label;
        btn.setAttribute("aria-label", label);
        updateCardsToggleUi();
        return;
      }

      if(act === "moveUp" || act === "moveDown"){
        const idx = items.findIndex(x => x.id === id);
        if(idx < 0) return;

        const to = (act === "moveUp") ? Math.max(0, idx - 1) : Math.min(items.length - 1, idx + 1);
        if(to === idx) return;

        const [moved] = items.splice(idx, 1);
        items.splice(to, 0, moved);
        persist();
        render();
        return;
      }


      if(act === "del"){
        const it = items.find(x => x.id === id);
        const label = it ? (it.name ? `${it.name} (${it.symbol})` : it.symbol) : id;
        const ok = window.confirm(`确认删除：${label}？\n此操作不可恢复。`);
        if(!ok) return;

        setCardCollapsed(id, false);
        items = items.filter(x => x.id !== id);
        persist();
        render();
        return;
      }

      if(act === "edit"){
        openModal("edit", id);
        return;
      }

      if(act === "refresh"){
        await updateOnePrice(id);
        persist();
        updateValuesOnly();
        return;
      }
    });

    document.getElementById("btnUpdateAll").addEventListener("click", async () => {
      await updateAllPrices();
    });

    // ---------- Manual reordering ----------
    let sortMode = false;
    function setSortMode(on){
      sortMode = !!on;
      document.body.classList.toggle("sort-mode", sortMode);
      const btn = document.getElementById("btnSort");
      if(btn) btn.textContent = sortMode ? "完成" : "排序";
      if(sortMode) toast("排序模式：用 ↑/↓ 调整卡片顺序");
    }
    document.getElementById("btnSort").addEventListener("click", () => setSortMode(!sortMode));

    document.getElementById("btnAdd").addEventListener("click", () => openModal("add"));

    // ---------- Import / Export (local JSON) ----------
    const ioOverlay = document.getElementById("ioOverlay");
    const btnIO = document.getElementById("btnIO");
    const btnIOClose = document.getElementById("btnIOClose");
    const ioFile = document.getElementById("ioFile");
    const btnExport = document.getElementById("btnExport");
    const btnImport = document.getElementById("btnImport");
    const bgRefreshToggle = document.getElementById("bgRefreshToggle");
    const amoledToggle = document.getElementById("amoledToggle");

    function openIO(){
      if(!ioOverlay) return;
      if(amoledToggle) amoledToggle.checked = (activeTheme === THEME_AMOLED);
      ioOverlay.classList.add("show");
      ioOverlay.setAttribute("aria-hidden","false");
    }
    function closeIO(){
      if(!ioOverlay) return;
      ioOverlay.classList.remove("show");
      ioOverlay.setAttribute("aria-hidden","true");
      if(ioFile) ioFile.value = "";
    }

    if(btnIO) btnIO.addEventListener("click", openIO);
    if(btnIOClose) btnIOClose.addEventListener("click", closeIO);
    if(ioOverlay){
      ioOverlay.addEventListener("click", (e) => { if(e.target === ioOverlay) closeIO(); });
    }
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && ioOverlay && ioOverlay.classList.contains("show")) closeIO();
    });

    if(bgRefreshToggle){
      bgRefreshToggle.checked = !!allowBgRefresh;
      bgRefreshToggle.addEventListener("change", () => {
        allowBgRefresh = !!bgRefreshToggle.checked;
        try{ localStorage.setItem(LS_BG_REFRESH_KEY, allowBgRefresh ? "1" : "0"); }catch(_){ /* ignore */ }
        toast(allowBgRefresh ? "已开启后台刷新" : "已关闭后台刷新");
      });
    }

    if(amoledToggle){
      amoledToggle.checked = (activeTheme === THEME_AMOLED);
      amoledToggle.addEventListener("change", () => {
        const next = amoledToggle.checked ? THEME_AMOLED : THEME_LIGHT;
        try{ localStorage.setItem(LS_THEME_KEY, next); }catch(_){ /* ignore */ }
        applyTheme(next);
        toast(next === THEME_AMOLED ? "已开启夜间模式（AMOLED）" : "已关闭夜间模式（AMOLED）");
      });
    }

    // ---------- Threshold Alerts (Stop-loss / Breakout / Take-profit) ----------
    const LS_ALERTS_KEY = "strategy_cards_threshold_alerts_v1";
    const LS_ALERT_ACK_KEY = "strategy_cards_threshold_alert_ack_v1";

    let alertsEnabled = true;
    try{ alertsEnabled = localStorage.getItem(LS_ALERTS_KEY) !== "0"; }catch(_){ /* ignore */ }

    /** @type {Record<string, {stop?:string, breakout?:string, tp1?:string, tp2?:string}>} */
    let alertAck = {};
    try{
      alertAck = JSON.parse(localStorage.getItem(LS_ALERT_ACK_KEY) || "{}") || {};
    }catch(_){
      alertAck = {};
    }
    function saveAlertAck(){
      try{ localStorage.setItem(LS_ALERT_ACK_KEY, JSON.stringify(alertAck)); }catch(_){ /* ignore */ }
    }
    function priceKey(v){
      const n = Number(v);
      return Number.isFinite(n) ? String(n) : "";
    }

    const alertToggle = document.getElementById("alertToggle");
    if(alertToggle){
      alertToggle.checked = !!alertsEnabled;
      alertToggle.addEventListener("change", () => {
        alertsEnabled = !!alertToggle.checked;
        try{ localStorage.setItem(LS_ALERTS_KEY, alertsEnabled ? "1" : "0"); }catch(_){ /* ignore */ }
        toast(alertsEnabled ? "已开启阈值弹窗通知" : "已关闭阈值弹窗通知");
      });
    }

    const alertOverlay = document.getElementById("alertOverlay");
    const alertTitle = document.getElementById("alertTitle");
    const alertBody = document.getElementById("alertBody");
    const btnAlertOk = document.getElementById("btnAlertOk");

    /** @type {{id:string, type:"stop"|"breakout"|"tp1"|"tp2", symbol:string, name:string, price:number, level:number}[]} */
    const alertQueue = [];
    const alertLastTs = new Map(); // key: `${id}:${type}:${levelKey}`
    const ALERT_COOLDOWN_MS = 5 * 60 * 1000;
    let alertShowing = false;
    let currentAlert = null;

    function openAlertModal(payload){
      if(!alertOverlay) return;

      const baseTitle = `${payload.name ? payload.name + " " : ""}${payload.symbol}`;
      const statusText =
        payload.type === "stop" ? "已止损" :
        payload.type === "tp2"  ? "已止盈2" :
        payload.type === "tp1"  ? "已止盈1" :
        "已突破";

      if(alertTitle){
        alertTitle.textContent = baseTitle;
        const tag = document.createElement("span");
        tag.className = `alert-tag alert-${payload.type}`;
        tag.textContent = statusText;
        alertTitle.appendChild(document.createTextNode(" "));
        alertTitle.appendChild(tag);
      }

      const priceStr = formatCNY(payload.price);
      const levelStr = formatCNY(payload.level);
      const which =
        payload.type === "stop" ? "止损位" :
        payload.type === "tp2"  ? "止盈2" :
        payload.type === "tp1"  ? "止盈1" :
        "突破位";

      if(alertBody){
        alertBody.innerHTML = `现价 <b>${priceStr}</b> 达到 ${which} <b>${levelStr}</b> 价格位，请确认。`;
      }
      alertOverlay.classList.add("show");
      alertOverlay.setAttribute("aria-hidden","false");
      alertShowing = true;
      currentAlert = payload;
    }
    function closeAlertModal(){
      if(!alertOverlay) return;
      alertOverlay.classList.remove("show");
      alertOverlay.setAttribute("aria-hidden","true");
      alertShowing = false;
      currentAlert = null;
    }
    function showNextAlert(){
      if(alertShowing) return;
      const next = alertQueue.shift();
      if(!next) return;
      openAlertModal(next);
    }
    function ackAlert(payload){
      if(!payload || !payload.id) return;
      const key = payload.type;
      const pk = priceKey(payload.level);
      if(!pk) return;
      if(!alertAck[payload.id]) alertAck[payload.id] = {};
      alertAck[payload.id][key] = pk;
      saveAlertAck();
    }
    if(btnAlertOk){
      btnAlertOk.addEventListener("click", () => {
        if(currentAlert) ackAlert(currentAlert);
        closeAlertModal();
        showNextAlert();
      });
    }

    function enqueueAlert(payload){
      if(!payload || !payload.id) return;
      // store context for ack on the overlay when shown
      alertQueue.push(payload);
      if(!alertShowing) showNextAlert();
    }

    function maybeEnqueueThresholdAlerts(it, prevPrice){
      if(!alertsEnabled) return;
      if(!it || !it.id) return;
      if(isCallAuctionNow()) return;

      const cur = Number(it.price);
      if(!Number.isFinite(cur)) return;

      const prev = Number(prevPrice);
      const hasPrev = Number.isFinite(prev);

      const name = String(it.name || "").trim();
      const symbol = String(it.symbol || "").trim();
      const now = Date.now();

      const canEnqueue = (type, level) => {
        const levelKey = priceKey(level);
        const k = `${it.id}:${type}:${levelKey}`;

        // avoid duplicates while an alert is being shown or queued
        if(currentAlert && currentAlert.id === it.id && currentAlert.type === type && priceKey(currentAlert.level) === levelKey) return false;
        if(alertQueue.some(x => x.id === it.id && x.type === type && priceKey(x.level) === levelKey)) return false;

        const last = alertLastTs.get(k) || 0;
        if(now - last < ALERT_COOLDOWN_MS) return false;
        alertLastTs.set(k, now);
        return true;
      };

      // Priority: stop-loss first (only when crossing the threshold)
      const stop = Number(it.stop);
      if(Number.isFinite(stop) && cur <= stop && (!hasPrev || prev > stop)){
        const ack = (alertAck[it.id] && alertAck[it.id].stop) ? String(alertAck[it.id].stop) : "";
        if(ack !== priceKey(stop) && canEnqueue("stop", stop)){
          enqueueAlert({ id: it.id, type: "stop", symbol, name, price: cur, level: stop });
        }
        return;
      }

      // Then take-profit (higher target first), only when crossing the threshold
      const tp2 = (it.tp2 === null || it.tp2 === undefined || it.tp2 === "") ? NaN : Number(it.tp2);
      if(Number.isFinite(tp2) && cur >= tp2 && (!hasPrev || prev < tp2)){
        const ack = (alertAck[it.id] && alertAck[it.id].tp2) ? String(alertAck[it.id].tp2) : "";
        if(ack !== priceKey(tp2) && canEnqueue("tp2", tp2)){
          enqueueAlert({ id: it.id, type: "tp2", symbol, name, price: cur, level: tp2 });
        }
        return;
      }

      const tp1 = Number(it.tp1);
      if(Number.isFinite(tp1) && cur >= tp1 && (!hasPrev || prev < tp1)){
        const ack = (alertAck[it.id] && alertAck[it.id].tp1) ? String(alertAck[it.id].tp1) : "";
        if(ack !== priceKey(tp1) && canEnqueue("tp1", tp1)){
          enqueueAlert({ id: it.id, type: "tp1", symbol, name, price: cur, level: tp1 });
        }
        return;
      }

      const bo = (it.breakout === null || it.breakout === undefined || it.breakout === "") ? NaN : Number(it.breakout);
      if(Number.isFinite(bo) && cur >= bo && (!hasPrev || prev < bo)){
        const ack = (alertAck[it.id] && alertAck[it.id].breakout) ? String(alertAck[it.id].breakout) : "";
        if(ack !== priceKey(bo) && canEnqueue("breakout", bo)){
          enqueueAlert({ id: it.id, type: "breakout", symbol, name, price: cur, level: bo });
        }
      }
    }

    function downloadJSON(filename, obj){
      const s = JSON.stringify(obj, null, 2);
      const blob = new Blob([s], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 3000);
    }

    function safeNum(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    function genId(){
      // Best-effort unique id without external deps
      try{
        if (crypto && crypto.randomUUID) return crypto.randomUUID();
      }catch(_){}
      return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 9);
    }

    function normalizeImportedItems(arr){
      if(!Array.isArray(arr)) throw new Error("INVALID_FORMAT");
      return arr.map((o) => {
        const symbol = String((o && o.symbol) || "").trim();
        if(!symbol) throw new Error("MISSING_SYMBOL");
        return {
          id: String((o && o.id) || genId()),
          symbol,
          name: (o && o.name) ? String(o.name) : "",
          stop: safeNum(o && o.stop),
          support: safeNum(o && o.support),
          breakout: (o && (o.breakout !== undefined) && (o.breakout !== "") && (o.breakout !== null)) ? safeNum(o.breakout) : null,
          tp1: safeNum(o && o.tp1),
          tp2: (o && (o.tp2 !== undefined) && (o.tp2 !== "") && (o.tp2 !== null)) ? safeNum(o.tp2) : null,
          // runtime fields (best-effort defaults)
          price: safeNum(o && o.price) ?? 0,
          prevClose: safeNum(o && o.prevClose) ?? 0,
          open: safeNum(o && o.open) ?? 0,
          high: safeNum(o && o.high) ?? 0,
          low: safeNum(o && o.low) ?? 0,
          avgPrice: safeNum(o && o.avgPrice) ?? 0,
          volRatio: safeNum(o && o.volRatio) ?? 0,
          status: (o && o.status) ? String(o.status).trim() : "监控中",
          updatedAt: (o && o.updatedAt) ? String(o.updatedAt) : ""
        };
      });
    }

    if(btnExport){
      btnExport.addEventListener("click", () => {
        const filename = "stock-cards.json";
        downloadJSON(filename, items);
        toast("已导出 JSON");
      });
    }

    if(btnImport){
      btnImport.addEventListener("click", () => {
        if(ioFile) ioFile.click();
      });
    }

    if(ioFile){
      ioFile.addEventListener("change", async () => {
        const f = ioFile.files && ioFile.files[0];
        if(!f) return;
        try{
          const txt = await f.text();
          const obj = JSON.parse(txt);
          const imported = normalizeImportedItems(obj);
          const ok = window.confirm(`确认导入 ${imported.length} 条记录？\n将覆盖当前本地股票列表。`);
          if(!ok) return;

          items = imported;
          persist();
          render();
          toast("导入成功");
          closeIO();
          // Sync quotes/status immediately after import so dashboard trigger-top reflects reality.
          updateAllPrices().catch((e)=>console.warn("import sync updateAllPrices failed", e));
        }catch(err){
          console.error(err);
          toast("导入失败：文件格式不正确");
        }
      });
    }
    // ---------- Modal logic ----------
    const overlay = document.getElementById("overlay");
    const modalTitle = document.getElementById("modalTitle");
    const fSymbol = document.getElementById("fSymbol");
    const fNote = document.getElementById("fNote");
    const fStop = document.getElementById("fStop");
    const fSupport = document.getElementById("fSupport");
    const fBreakout = document.getElementById("fBreakout");
    const fTp1 = document.getElementById("fTp1");
    const fTp2 = document.getElementById("fTp2");
    const btnClose = document.getElementById("btnClose");
    const btnCancel = document.getElementById("btnCancel");
    const btnSave = document.getElementById("btnSave");

    function wireDraft(){
      // Draft caching disabled: keep add-form inputs blank by default.
      return;
    }
    // wireDraft();

    let modalMode = "add"; // "add" | "edit"
    let editingId = null;

    function openModal(mode, id=null){
      modalMode = mode;
      editingId = id;

      if(mode === "add"){
        modalTitle.textContent = "添加股票";
        // Default blank inputs (no draft restore)
        try{ localStorage.removeItem(LS_DRAFT_KEY); }catch(_){ /* ignore */ }
        fSymbol.value = "";
        if(fNote) fNote.value = "";
        fStop.value = "";
        fSupport.value = "";
        fBreakout.value = "";
        fTp1.value = "";
        fTp2.value = "";
      }else{
        const it = items.find(x => x.id === id);
        if(!it) return;
        modalTitle.textContent = "编辑股票";
        fSymbol.value = it.symbol;
        if(fNote) fNote.value = String(it.note ?? "");
        fStop.value = String(it.stop ?? "");
        fSupport.value = String(it.support ?? "");
        fBreakout.value = (Number.isFinite(it.breakout) ? String(it.breakout) : "");
        fTp1.value = String(it.tp1 ?? "");
        fTp2.value = (Number.isFinite(it.tp2) ? String(it.tp2) : "");
      }

      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
      setTimeout(() => fSymbol.focus(), 50);
    }

    function closeModal(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
      editingId = null;
    }

    btnClose.addEventListener("click", closeModal);
    btnCancel.addEventListener("click", closeModal);
    overlay.addEventListener("click", (e) => {
      if(e.target === overlay) closeModal();
    });

    function parseNum(v){
      const n = Number(String(v).replaceAll(",","").trim());
      return Number.isFinite(n) ? n : NaN;
    }
    function parseOptionalNum(v){
      const s = String(v ?? "").trim();
      if(!s) return null;
      const n = Number(s.replaceAll(",",""));
      return Number.isFinite(n) ? n : NaN;
    }

    btnSave.addEventListener("click", async () => {
      const symbol = fSymbol.value.trim();
      const note = (fNote ? fNote.value.trim() : "");
      const stop = parseNum(fStop.value);
      const support = parseNum(fSupport.value);
      const breakout = parseOptionalNum(fBreakout.value);
      const tp1 = parseNum(fTp1.value);
      const tp2 = parseOptionalNum(fTp2.value);

      if(!/^\d{6}$/.test(symbol)){
        toast("请输入 6 位股票代码");
        fSymbol.focus();
        return;
      }
      if(!Number.isFinite(stop) || !Number.isFinite(support) || !Number.isFinite(tp1)){
        toast("止损/支撑/止盈1 请输入有效数字");
        return;
      }
      if(breakout !== null && !Number.isFinite(breakout)){
        toast("突破位 请输入有效数字或留空");
        return;
      }
      if(tp2 !== null && !Number.isFinite(tp2)){
        toast("止盈2 请输入有效数字或留空");
        return;
      }
      if(tp2 !== null && tp2 <= tp1){
        toast("止盈2 需要大于 止盈1（或留空）");
        return;
      }

      if(modalMode === "add"){
        const it = {
          id: crypto.randomUUID(),
          symbol,
          price: NaN,
          prevClose: NaN,
          open: NaN,
          high: NaN,
          low: NaN,
          avgPrice: NaN,
          volRatio: NaN,
          status: "监控中",
          updatedAt: "--:--:--",
          note,
          stop, support, breakout, tp1, tp2
        };
        items.unshift(it);
      }else{
        const it = items.find(x => x.id === editingId);
        if(!it) return;
        it.symbol = symbol;
        it.note = note;
        it.stop = stop;
        it.support = support;
        it.breakout = breakout;
        it.tp1 = tp1;
        it.tp2 = tp2;
      }

      persist();
      render();
      closeModal();

      await updateAllPrices();
    });

    // ---------- Price update (real) ----------
    async function updateAllPrices(){
      if(items.length === 0) return;

      const marketCodes = [];
      for(const it of items){
        try{
          const mc = toTencentMarketCode(it.symbol);
          it.marketCode = mc;
          marketCodes.push(mc);
        }catch(_){}
      }

      if(marketCodes.length === 0){
        toast("没有可更新的股票代码");
        return;
      }

      try{
        const quotes = await fetchTencentBatch(marketCodes);
        const map = new Map();
        for(const q of quotes){
          map.set(q.marketCode, q);
        }

        for(const it of items){
          const mc = it.marketCode || null;
          if(!mc) continue;
          const q = map.get(mc);
          if(!q) continue;

          if(q.error){
            it.updatedAt = nowTime();
            it.status = "更新失败";
            continue;
          }

          const prevPrice = Number(it.price);

          it.price = q.price;
          it.prevClose = q.prevClose;
          it.open = q.open;
          it.high = q.high;
          it.low = q.low;
          it.avgPrice = q.avgPrice;
          it.volRatio = q.volRatio;
          it.updatedAt = q.time || nowTime();
          it.name = q.name || it.name;
          // status rule: <= stop => 已止损; >= tp2 => 已止盈2; >= tp1 => 已止盈1; >= breakout(可选) => 已突破; else 监控中
          if(q.indicative){
            it.status = "监控中";
          }else if(isCallAuctionNow()){
            // Call auction can have noisy/indicative prints; keep previous status to avoid false triggers.
            if(it.status === "更新失败") it.status = "监控中";
          }else{
            const prevStatus = it.status;
            if (Number(it.price) <= Number(it.stop)) it.status = "已止损";
            else if (Number.isFinite(it.tp2) && Number(it.price) >= Number(it.tp2)) it.status = "已止盈2";
            else if (Number(it.price) >= Number(it.tp1)) it.status = "已止盈1";
            else if (Number.isFinite(it.breakout) && Number(it.price) >= Number(it.breakout)) it.status = "已突破";
            else it.status = "监控中";

            // Breakout duration tracking (clears on next day or when falling below breakout)
            if(it.status === "已突破"){
              if(prevStatus !== "已突破") ensureBreakoutStart(it.symbol);
              else ensureBreakoutStart(it.symbol); // ensure exists (e.g., after reload)
            }else{
              if(prevStatus === "已突破") clearBreakoutStart(it.symbol);
            }

            maybeEnqueueThresholdAlerts(it, prevPrice);
          }
        }

        persist();
        updateValuesOnly();
      }catch(e){
        toast(`批量更新失败: ${String(e.message || e)}`);
      }
    }

    async function updateOnePrice(id){
      const it = items.find(x => x.id === id);
      if(!it) return;

      let mc = "";
      try{
        mc = toTencentMarketCode(it.symbol);
        it.marketCode = mc;
      }catch(_){
        toast("股票代码不合法");
        return;
      }

      try{
        const quotes = await fetchTencentBatch([mc]);
        const q = quotes[0];
        if(!q || q.error) throw new Error(q?.error || "empty quote");

        const prevPrice = Number(it.price);

        it.price = q.price;
        it.prevClose = q.prevClose;
        it.open = q.open;
        it.high = q.high;
        it.low = q.low;
        it.avgPrice = q.avgPrice;
        it.volRatio = q.volRatio;
        it.updatedAt = q.time || nowTime();
        it.name = q.name || it.name;
        // status rule: <= stop => 已止损; >= tp2 => 已止盈2; >= tp1 => 已止盈1; >= breakout(可选) => 已突破; else 监控中
        if(q.indicative){
          it.status = "监控中";
        }else if(isCallAuctionNow()){
          // Call auction: keep previous status to avoid false triggers.
          if(it.status === "更新失败") it.status = "监控中";
        }else{
          if (Number(it.price) <= Number(it.stop)) it.status = "已止损";
          else if (Number.isFinite(it.tp2) && Number(it.price) >= Number(it.tp2)) it.status = "已止盈2";
          else if (Number(it.price) >= Number(it.tp1)) it.status = "已止盈1";
          else if (Number.isFinite(it.breakout) && Number(it.price) >= Number(it.breakout)) it.status = "已突破";
          else it.status = "监控中";

          maybeEnqueueThresholdAlerts(it, prevPrice);
        }
      }catch(e){
        it.status = "更新失败";
        it.updatedAt = nowTime();
        toast(`更新失败: ${String(e.message || e)}`);
      }
    }

    // ---------- 5s auto refresh ----------
    let timer = null;
    function startAutoRefresh(){
      if(timer) clearInterval(timer);
      timer = setInterval(() => {
        if ((allowBgRefresh || document.visibilityState === "visible") && !isAutoRefreshLocked()){
          if (document.visibilityState === "visible") checkNewDayResetPrompt();
          updateAllPrices();
        }
      }, 5000);
    }
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible"){
        checkNewDayResetPrompt();
        updateAllPrices();
      }
    });

    // ---------- Tiny toast ----------
    let toastTimer = null;
    function toast(msg){
      clearTimeout(toastTimer);
      let el = document.getElementById("toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.style.position = "fixed";
        el.style.left = "50%";
        el.style.bottom = "18px";
        el.style.transform = "translateX(-50%)";
        el.style.background = "rgba(17,24,39,.92)";
        el.style.color = "white";
        el.style.padding = "10px 12px";
        el.style.borderRadius = "14px";
        el.style.fontWeight = "900";
        el.style.fontSize = "13px";
        el.style.boxShadow = "0 16px 40px rgba(17,24,39,.25)";
        el.style.zIndex = "100";
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.opacity = "1";
      toastTimer = setTimeout(() => { el.style.opacity = "0"; }, 1400);
    }

    // Prevent iOS Safari pinch-zoom (best-effort)
    try{
      document.addEventListener("gesturestart", (e) => e.preventDefault(), { passive:false });
      document.addEventListener("gesturechange", (e) => e.preventDefault(), { passive:false });
      document.addEventListener("gestureend", (e) => e.preventDefault(), { passive:false });
    }catch(_){/* ignore */}

    
    // PWA: register Service Worker (required for Chrome "Install app")
    try{
      if("serviceWorker" in navigator){
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("./sw.js", { scope: "./" }).catch(()=>{});
        });
      }
    }catch(_){/* ignore */}
// Initial
    render();
    persist();
    checkNewDayResetPrompt();
    startAutoRefresh();
    updateAllPrices();
  </script>
</body>
</html>